<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>è¯Šæ–­æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #10b77f; }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #10b77f;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 4px;
        }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
        button {
            background: #10b77f;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #059669; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
        }
        .log-info { color: #4ec9b0; }
        .log-error { color: #f48771; }
        .log-success { color: #b5cea8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ¿ Emission Agent è¯Šæ–­æµ‹è¯•</h1>

        <div class="test-section">
            <h2>1. APIè¿æ¥æµ‹è¯•</h2>
            <button onclick="testHealth()">æµ‹è¯•å¥åº·æ£€æŸ¥</button>
            <button onclick="testSession()">æµ‹è¯•ä¼šè¯åˆ›å»º</button>
            <button onclick="testChat()">æµ‹è¯•å‘é€æ¶ˆæ¯</button>
            <div id="api-results" class="result"></div>
        </div>

        <div class="test-section">
            <h2>2. å‰ç«¯DOMæµ‹è¯•</h2>
            <button onclick="testDOM()">æµ‹è¯•DOMå…ƒç´ </button>
            <div id="dom-results" class="result"></div>
        </div>

        <div class="test-section">
            <h2>3. æµè§ˆå™¨Consoleæ—¥å¿—</h2>
            <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
            <button onclick="window.location.href='/'">æ‰“å¼€ä¸»é¡µé¢</button>
            <div id="console-logs" class="log"></div>
        </div>

        <div class="test-section">
            <h2>4. ç½‘ç»œè¯·æ±‚ç›‘æ§</h2>
            <div id="network-monitor" class="result">
                <p>æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…· (F12) â†’ Network æ ‡ç­¾æŸ¥çœ‹ç½‘ç»œè¯·æ±‚</p>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let sessionId = null;

        // æ•è·consoleæ—¥å¿—
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addLog(message, type = 'info') {
            const logsDiv = document.getElementById('console-logs');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog(args.join(' '), 'info');
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('ERROR: ' + args.join(' '), 'error');
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLog('WARN: ' + args.join(' '), 'info');
        };

        function clearLogs() {
            document.getElementById('console-logs').innerHTML = '';
        }

        async function testHealth() {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.innerHTML = '<p>æµ‹è¯•ä¸­...</p>';

            try {
                console.log('æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹...');
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();

                if (response.ok) {
                    resultsDiv.innerHTML = `
                        <p class="pass">âœ“ å¥åº·æ£€æŸ¥é€šè¿‡</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                    console.log('å¥åº·æ£€æŸ¥æˆåŠŸ:', data);
                } else {
                    resultsDiv.innerHTML = `<p class="fail">âœ— å¥åº·æ£€æŸ¥å¤±è´¥: ${response.status}</p>`;
                    console.error('å¥åº·æ£€æŸ¥å¤±è´¥:', response.status);
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p class="fail">âœ— è¿æ¥å¤±è´¥: ${error.message}</p>`;
                console.error('è¿æ¥å¤±è´¥:', error);
            }
        }

        async function testSession() {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.innerHTML = '<p>æµ‹è¯•ä¸­...</p>';

            try {
                console.log('æµ‹è¯•ä¼šè¯åˆ›å»º...');
                const response = await fetch(`${API_BASE}/sessions/new`, {
                    method: 'POST'
                });
                const data = await response.json();

                if (response.ok) {
                    sessionId = data.session_id;
                    resultsDiv.innerHTML = `
                        <p class="pass">âœ“ ä¼šè¯åˆ›å»ºæˆåŠŸ</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                    console.log('ä¼šè¯åˆ›å»ºæˆåŠŸ:', data);
                } else {
                    resultsDiv.innerHTML = `<p class="fail">âœ— ä¼šè¯åˆ›å»ºå¤±è´¥: ${response.status}</p>`;
                    console.error('ä¼šè¯åˆ›å»ºå¤±è´¥:', response.status);
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p class="fail">âœ— è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
                console.error('è¯·æ±‚å¤±è´¥:', error);
            }
        }

        async function testChat() {
            const resultsDiv = document.getElementById('api-results');

            if (!sessionId) {
                resultsDiv.innerHTML = '<p class="fail">âœ— è¯·å…ˆåˆ›å»ºä¼šè¯</p>';
                return;
            }

            resultsDiv.innerHTML = '<p>æµ‹è¯•ä¸­...</p>';

            try {
                console.log('æµ‹è¯•å‘é€æ¶ˆæ¯...');
                const formData = new FormData();
                formData.append('message', 'æµ‹è¯•æ¶ˆæ¯');
                formData.append('session_id', sessionId);

                const response = await fetch(`${API_BASE}/chat`, {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (response.ok) {
                    resultsDiv.innerHTML = `
                        <p class="pass">âœ“ æ¶ˆæ¯å‘é€æˆåŠŸ</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                    console.log('æ¶ˆæ¯å‘é€æˆåŠŸ:', data);
                } else {
                    resultsDiv.innerHTML = `<p class="fail">âœ— æ¶ˆæ¯å‘é€å¤±è´¥: ${response.status}</p>`;
                    console.error('æ¶ˆæ¯å‘é€å¤±è´¥:', response.status);
                }
            } catch (error) {
                resultsDiv.innerHTML = `<p class="fail">âœ— è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
                console.error('è¯·æ±‚å¤±è´¥:', error);
            }
        }

        async function testDOM() {
            const resultsDiv = document.getElementById('dom-results');

            // åœ¨æ–°çª—å£æ‰“å¼€ä¸»é¡µé¢å¹¶æµ‹è¯•DOM
            const mainWindow = window.open('/', '_blank');

            setTimeout(() => {
                try {
                    const messagesContainer = mainWindow.document.getElementById('messages-container');
                    const inputArea = mainWindow.document.getElementById('input-area');

                    let html = '<h3>DOMå…ƒç´ æ£€æŸ¥ç»“æœï¼š</h3>';

                    if (messagesContainer) {
                        html += '<p class="pass">âœ“ messages-container å­˜åœ¨</p>';
                        console.log('messages-container æ‰¾åˆ°');
                    } else {
                        html += '<p class="fail">âœ— messages-container ä¸å­˜åœ¨</p>';
                        console.error('messages-container æœªæ‰¾åˆ°');
                    }

                    if (inputArea) {
                        html += '<p class="pass">âœ“ input-area å­˜åœ¨</p>';
                        console.log('input-area æ‰¾åˆ°');
                    } else {
                        html += '<p class="fail">âœ— input-area ä¸å­˜åœ¨</p>';
                        console.error('input-area æœªæ‰¾åˆ°');
                    }

                    resultsDiv.innerHTML = html;
                } catch (error) {
                    resultsDiv.innerHTML = `<p class="fail">âœ— æ— æ³•è®¿é—®ä¸»é¡µé¢DOM: ${error.message}</p>`;
                    console.error('DOMæµ‹è¯•å¤±è´¥:', error);
                }
            }, 2000);

            resultsDiv.innerHTML = '<p>å·²æ‰“å¼€ä¸»é¡µé¢ï¼Œ2ç§’åæ£€æŸ¥DOM...</p>';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡Œå¥åº·æ£€æŸ¥
        window.addEventListener('load', () => {
            console.log('è¯Šæ–­é¡µé¢å·²åŠ è½½');
            testHealth();
        });
    </script>
</body>
</html>
