# 排放计算Agent系统问题总结

**总结日期**: 2026-01-27
**基于文档**: MACRO_SKILL_ISSUES_ANALYSIS.md

---

## 核心问题概览

系统存在 **4个主要问题**，其中1个严重问题直接影响计算准确性。

---

## 🔴 严重问题

### 问题1: 计算结果严重错误

**现象**:
- 车流量从800辆/h增加到1200辆/h（增加50%）
- CO2排放量从8170.38 kg/h **降低**到3426.54 kg/h（减少58%）
- **逻辑矛盾**: 车流量增加，排放量反而减少

**影响**:
- 用户得到完全错误的计算结果
- 严重影响系统可信度
- **风险等级: 高**

**可能原因**:
1. 参数合并过程中links_data结构被破坏
2. 参数更新逻辑错误（`_update_list_items`方法）
3. 反思修复器在修复过程中破坏了数据

---

## ⚠️ 重要问题

### 问题2: 增量查询导致Planning验证失败

**现象**:
```
用户: "如果车流量改成1200辆呢？"
错误: Planning验证失败
  - 'links_data类型错误，期望list'
  - 'links_data必须是列表，当前类型: str'
```

**可能原因**:
1. Planning LLM生成了错误格式: `{"links_data": "从上下文获取"}`
2. 参数合并逻辑存在边界情况问题
3. System Prompt指导不够明确

---

### 问题3: 回顾性查询无法获取数值结果

**现象**:
```
用户: "刚才CO2的结果是多少？"
Agent: "历史记录中只显示了函数调用，没有包含具体的计算结果数值"
```

**原因**:
- `ConversationContext`的`_summarize_turn`方法只保存参数，不保存结果数据
- 代码位置: `agent/context.py:184-193`

---

### 问题4: Planning延迟过高

**现象**:
- 平均延迟: 17.9秒
- P95延迟: 26.2秒
- **目标**: <5秒

**延迟来源**:
- Planning LLM调用: ~8-10秒
- Synthesis LLM调用: ~5-7秒
- Skill执行: ~1-2秒
- 反思修复（如需要）: +8-10秒

---

## 修复优先级

### 🔴 优先级1: 修复计算结果错误
- 添加调试日志追踪参数流转
- 验证参数合并逻辑
- 检查Reflector修复逻辑
- 添加参数验证

### ⚠️ 优先级2: 修复Planning验证失败
- 优化System Prompt
- 增强参数合并健壮性
- 改进Reflector处理错误格式

### ⚠️ 优先级3: 改进回顾性查询
- 增强上下文总结，包含计算结果数值
- 优化Synthesis Prompt

### 💡 优先级4: 性能优化
- 使用更快的模型处理简单查询
- 并行化Planning和数据加载
- 优化Prompt长度

---

## 需要检查的关键文件

1. **agent/context.py**
   - `merge_params` 方法
   - `_merge_macro_emission_params` 方法
   - `_update_list_items` 方法 ⚠️
   - `_summarize_turn` 方法

2. **agent/core.py**
   - `_enrich_plan_for_validation` 方法
   - `_plan_with_validation` 方法

3. **agent/reflector.py**
   - `_llm_based_fix` 方法

4. **agent/prompts/system.py**
   - 增量对话示例

5. **skills/macro_emission/skill.py**
   - `execute` 方法

---

## 测试用例

### 测试1: 基本增量查询
```
1. "2公里道路，40km/h，800辆/小时，70%小汽车30%公交车，CO2"
2. "改成1000辆"
预期: CO2排放量应该是第一次的 1.25倍
```

### 测试2: 多次增量修改
```
1. "2公里道路，40km/h，800辆/小时，70%小汽车30%公交车，CO2"
2. "PM2.5呢？"
3. "改成1200辆"
4. "速度改成60km/h"
预期: 每次修改都应该正确累积
```

### 测试3: 回顾性查询
```
1. "2公里道路，40km/h，800辆/小时，70%小汽车30%公交车，CO2"
2. "刚才CO2的结果是多少？"
预期: 应该能够准确回答数值
```

---

## 下一步行动

**立即执行**:
1. ✅ 创建问题总结文档（已完成）
2. 🔍 创建调试脚本，重现问题
3. 📝 添加详细日志，追踪参数流转
4. 🔧 根据诊断结果实施修复

**预计修复时间**: 2-4小时
**状态**: 等待诊断和修复

---

## 关键发现

1. **最严重的问题是计算结果错误** - 这会导致用户完全不信任系统
2. **增量查询功能存在缺陷** - 参数合并逻辑需要加强
3. **回顾性查询体验差** - 用户无法查看历史计算结果
4. **性能需要优化** - 17.9秒的平均延迟远超目标

**建议**: 优先修复问题1和问题2，这两个问题直接影响核心功能。
