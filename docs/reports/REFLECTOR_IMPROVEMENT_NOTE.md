# Reflector改进说明

## 问题
当前Reflector在修复增量查询时会生成完全错误的参数，因为它没有访问对话历史。

## 解决方案
Reflector应该更保守，对于缺少`links_data`的错误，应该返回`can_fix: false`，让参数合并逻辑处理。

## 修改位置
`agent/reflector.py` 的 `_build_reflection_prompt` 方法

## 需要添加的提示

在Prompt中添加：

```
## 重要提示

**对于增量查询（如"改成1200辆"）**:
- 如果错误是"缺少必需参数 links_data"或"links_data必须是列表"
- 这通常意味着Planning只提供了变化的字段（如traffic_flow_vph）
- **不要尝试修复**，返回 can_fix: false
- 原因：参数合并逻辑会自动从历史中获取完整参数

**只修复以下类型的错误**:
1. 字段名拼写错误（可以直接重命名）
2. 简单的类型转换（字符串数字转int/float）
3. 车型名称标准化

**不要修复**:
1. 缺少复杂嵌套结构（如links_data）
2. 需要从上下文推断的参数
3. 语义错误（速度、流量不合理等）
```

## 实施状态
由于字符串匹配问题，需要手动修改或使用其他方法。

建议：直接在 `_build_reflection_prompt` 方法的返回字符串中，在"## 任务"之前添加上述"## 重要提示"部分。
