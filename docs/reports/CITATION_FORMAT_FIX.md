# 知识检索引用格式修复

**问题报告日期**: 2026-01-24
**修复状态**: ✅ 已完成

## 问题描述

用户发现知识检索结果中存在引用格式问题：

### 问题1: 格式不一致
```
依据来源：
 • [来源1] 和
   [来源4]：环境保护部2016年第79号公告...

回答依据：以上信息全部来源于知识库检索结果，引用的标准包括《轻
型汽车污染物排放限值及测量方法》（GB 18352.1）、...【1】【2】【3】。
```

**问题点**:
1. 两个不同的章节标题："依据来源" vs "回答依据"
2. 引用格式混乱：[来源1] vs 【1】
3. 不完整的句子："[来源1] 和" 后面没有内容

### 问题2: 答案过长
- 第一个回答约500字，超出用户期望
- 包含过多格式化内容（表格、列表）

## 根本原因

**文件**: `skills/knowledge/skill.py` 的 `_refine_answer()` 方法

**原因**: Prompt太模糊，没有明确的格式要求
```python
## 要求
1. 基于检索结果回答，不要编造
2. 如果检索结果不足以回答，说明并建议其他查询方式
3. 引用来源编号  # ← 太模糊！
4. 保持简洁专业  # ← 没有具体标准
```

LLM在"引用来源编号"这个模糊指令下自由发挥，导致：
- 创建了多个引用章节
- 混用不同的引用格式
- 生成了不完整的句子

## 修复方案

### 修改内容

**文件**: `skills/knowledge/skill.py`

**修改**: 重写 `_refine_answer()` 的prompt，添加详细的格式要求

**新Prompt特点**:

1. **明确的内容要求**:
   ```
   - 回答长度控制在150-200字
   - 基于检索结果，不编造
   - 不足以回答时诚实说明
   ```

2. **严格的引用格式**:
   ```
   - 在句末用[来源1]、[来源2]标注
   - 示例："国六标准于2020年7月1日实施[来源1]。"
   - 不要创建单独的"依据来源"章节
   ```

3. **统一的结构**:
   ```
   - 直接回答问题
   - 简单的项目符号（如需列举）
   - 最后统一列出参考文档
   ```

4. **明确的禁止事项**:
   ```
   - 不要使用【1】【2】格式
   - 不要创建复杂表格
   - 不要重复引用说明
   ```

### 代码对比

**修复前**:
```python
prompt = f"""基于以下检索到的知识，回答用户问题。

## 要求
1. 基于检索结果回答，不要编造
2. 如果检索结果不足以回答，说明并建议其他查询方式
3. 引用来源编号
4. 保持简洁专业
"""
```

**修复后**:
```python
prompt = f"""基于以下检索到的知识，回答用户问题。

## 回答要求（重要）
1. **内容要求**：
   - 基于检索结果回答，不要编造信息
   - 回答长度控制在150-200字

2. **引用格式**（必须严格遵守）：
   - 在陈述事实时，在句末用[来源1]、[来源2]等标注
   - 示例："国六标准于2020年7月1日实施[来源1]。"
   - 不要创建单独的"依据来源"或"回答依据"章节

3. **结构要求**：
   - 直接回答问题，不要过度格式化
   - 最后一行列出参考文档：
     **参考文档**：
     1. 文档标题1
     2. 文档标题2

4. **禁止事项**：
   - 不要使用【1】【2】这种格式，统一用[来源1][来源2]
   - 不要创建复杂的表格（除非必要）
"""
```

## 预期效果

### 修复后的答案格式

```
国六排放标准是《轻型汽车污染物排放限值及测量方法（中国第六阶段）》
（GB18352.6—2016）[来源1]，是中国为防治机动车污染而制定的国家强
制性标准。该标准于2016年发布，2020年7月1日起在全国范围实施[来源2]。

主要要点：
- 适用范围：最大总质量不超过3.5吨的轻型汽车
- 实施日期：2020年7月1日起禁止生产国五车辆
- 标准效力：具有强制执行效力

**参考文档**：
1. 环境保护部2016年第79号公告
2. 生态环境部等四部门2020年5月13日公告
```

### 改进点

✅ **格式统一**: 只使用[来源1]格式
✅ **结构清晰**: 一个答案，一个参考文档列表
✅ **长度适中**: 150-200字
✅ **引用准确**: 每个事实都有来源标注
✅ **无重复**: 不会出现多个"依据来源"章节
✅ **句子完整**: 不会出现"[来源1] 和"这种不完整句子

## 测试验证

**测试脚本**: `test_citation_format.py`

**测试内容**:
1. 检查是否有不完整的句子
2. 检查是否有重复的依据章节
3. 检查是否混用了【】和[]
4. 检查答案长度是否合理
5. 统计引用次数和格式

**运行测试**:
```bash
python test_citation_format.py
```

## 相关文档

- `OPTIMIZATION_PLAN.md` - 完整优化计划
- `skills/knowledge/skill.py` - 修复的代码文件
- `test_citation_format.py` - 格式验证测试

## 总结

**问题**: 知识检索结果引用格式混乱、不一致、有错误

**原因**: LLM refiner的prompt太模糊，缺乏明确的格式规范

**解决**: 重写prompt，添加详细的格式要求和禁止事项

**效果**:
- 引用格式统一（[来源1]）
- 结构清晰（答案 + 参考文档）
- 长度适中（150-200字）
- 无格式错误

**状态**: ✅ 已修复，待测试验证

---

**修复日期**: 2026-01-24
**修复者**: Claude Sonnet 4.5
**优先级**: High（影响用户体验）
