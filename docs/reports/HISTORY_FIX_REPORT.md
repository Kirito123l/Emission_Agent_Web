# 历史记录功能修复说明

**修复日期**: 2026-01-25
**状态**: ✅ 已完成

---

## 修复内容

### 1. 添加会话历史加载功能

**新增函数**:
- `loadSessionList()` - 从API加载会话列表
- `renderSessionList(sessions)` - 渲染会话列表到侧边栏
- `loadSession(sessionId)` - 切换到指定会话

**功能特性**:
- ✅ 页面加载时自动加载会话历史
- ✅ 发送消息后自动更新会话列表
- ✅ 点击历史记录可切换会话
- ✅ 新建对话会清空消息并重置会话ID
- ✅ 当前会话高亮显示

### 2. 修改的文件

| 文件 | 修改内容 |
|------|----------|
| `web/app.js` | 添加会话历史管理功能 |

---

## 使用说明

### 查看历史记录

1. 打开应用后，左侧边栏会自动显示最近的会话
2. 最新的会话显示为高亮状态（白色背景）
3. 其他历史会话显示为灰色

### 切换会话

1. 点击左侧边栏的任意历史记录
2. 会话会切换到该记录
3. 新消息会使用该会话的ID

### 新建对话

1. 点击左上角的"New Calculation"按钮
2. 消息区域会清空
3. 会话ID会重置为null
4. 下次发送消息时会创建新会话

---

## 当前限制

### ⚠️ 会话历史消息未保存

**问题**: 目前切换会话时，之前的对话内容不会显示

**原因**:
1. API层没有保存每个会话的消息历史
2. Session类只保存了Agent实例，但Agent的对话历史在内存中
3. 没有提供获取会话历史消息的API端点

**影响**:
- 切换到旧会话时，看不到之前的对话
- 但Agent的上下文仍然保留（因为Agent实例在Session中）
- 继续对话时，Agent会记住之前的上下文

**解决方案**（未来改进）:
1. 在Session类中添加消息历史列表
2. 每次发送/接收消息时保存到历史
3. 添加API端点 `GET /api/sessions/{id}/messages`
4. 前端加载会话时显示历史消息

---

## 测试验证

### 测试步骤

1. **启动服务器**:
   ```bash
   python run_api.py
   ```

2. **打开应用**: http://localhost:8000

3. **发送几条消息**:
   - "查询2020年小汽车CO2排放因子"
   - "NOx呢？"
   - "计算一下"

4. **查看左侧边栏**:
   - 应该看到"查询2020年小汽车CO2排放因子..."
   - 点击可以切换回该会话

5. **新建对话**:
   - 点击"New Calculation"
   - 消息区域清空
   - 发送新消息会创建新会话

6. **查看会话列表**:
   - 应该看到两个会话
   - 最新的在最上面

---

## 技术细节

### API端点使用

```javascript
// 获取会话列表
GET /api/sessions
// 返回: { sessions: [{session_id, title, created_at, updated_at, message_count}] }

// 创建新会话
POST /api/sessions/new
// 返回: { session_id: "abc123" }

// 发送消息
POST /api/chat
// 参数: message, session_id, file
// 返回: { reply, session_id, data_type, chart_data, table_data, file_id }
```

### 会话标题生成

- 会话标题取自第一条消息的前20个字符
- 在`api/session.py`的`update_session_title`方法中实现
- 只在`message_count == 1`时更新

### 会话列表排序

- 按`updated_at`降序排列
- 最新的会话显示在最上面

---

## 关于Agent回答质量

### 当前配置

根据`.env`文件，Agent使用：
- Provider: DeepSeek
- Model: deepseek-chat
- Temperature: 0.0（高确定性）

### 可能的问题

1. **上下文不足**: Agent可能需要更多上下文信息
2. **Prompt需要优化**: Agent的系统提示词可能需要改进
3. **技能调用失败**: 某些技能可能没有正确调用

### 调试建议

1. **查看终端日志**:
   ```
   INFO:api.routes:=== 收到聊天请求 ===
   INFO:api.routes:消息: xxx
   INFO:api.routes:调用Agent处理消息...
   INFO:api.routes:Agent回复: xxx
   INFO:api.routes:检测到Skill结果: xxx
   ```

2. **测试具体场景**:
   - "查询2020年小汽车CO2排放因子" - 应该返回图表
   - 上传Excel文件 + "计算排放" - 应该返回表格
   - "什么是VSP？" - 应该返回知识检索结果

3. **检查Agent配置**:
   - 查看`agent/core.py`的系统提示词
   - 查看`agent/prompts/`目录下的提示词模板

---

## 下一步改进

### 优先级1: 会话历史消息保存
- 在Session类中添加消息历史
- 提供API端点获取历史消息
- 前端加载会话时显示历史

### 优先级2: Agent回答质量优化
- 优化系统提示词
- 添加更多示例
- 改进技能调用逻辑

### 优先级3: 用户体验改进
- 添加会话删除功能
- 添加会话重命名功能
- 添加搜索历史功能
- 添加导出对话功能

---

**修复完成时间**: 2026-01-25
**版本**: v2.2.2
**状态**: 基础功能已实现，待进一步优化
