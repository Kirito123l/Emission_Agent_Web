# å®è§‚Skillé—®é¢˜åˆ†æä¸ä¿®å¤è®¡åˆ’

**åˆ†ææ—¥æœŸ**: 2026-01-24
**åˆ†æè€…**: Claude Sonnet 4.5

## é—®é¢˜æ¦‚è¿°

åŸºäºç”¨æˆ·æä¾›çš„å®é™…å¯¹è¯æ—¥å¿—ï¼Œå‘ç°å®è§‚æ’æ”¾è®¡ç®—Skillå­˜åœ¨ä»¥ä¸‹ä¸¥é‡é—®é¢˜ï¼š

## é—®é¢˜1: å¢é‡æŸ¥è¯¢å¯¼è‡´PlanningéªŒè¯å¤±è´¥ âš ï¸

### ç°è±¡
```
ç”¨æˆ·: "å¦‚æœè½¦æµé‡æ”¹æˆ1200è¾†å‘¢ï¼Ÿ"
é”™è¯¯: PlanningéªŒè¯å¤±è´¥ (å°è¯•1):
  - 'æ­¥éª¤0: links_dataç±»å‹é”™è¯¯ï¼ŒæœŸæœ›list'
  - 'æ­¥éª¤0.links_data: å¿…é¡»æ˜¯åˆ—è¡¨'
  - 'æ­¥éª¤0: links_dataå¿…é¡»æ˜¯åˆ—è¡¨ï¼Œå½“å‰ç±»å‹: str'
```

### æ ¹æœ¬åŸå› åˆ†æ

**å¯èƒ½åŸå› 1: Planning LLMç”Ÿæˆäº†é”™è¯¯çš„å‚æ•°æ ¼å¼**
- LLMå¯èƒ½ç”Ÿæˆäº† `{"links_data": "ä»ä¸Šä¸‹æ–‡è·å–"}` è¿™æ ·çš„å­—ç¬¦ä¸²
- æˆ–è€…ç”Ÿæˆäº† `{"links_data": "ç»§æ‰¿å†å²å‚æ•°"}` ç­‰æè¿°æ€§æ–‡æœ¬

**å¯èƒ½åŸå› 2: å‚æ•°åˆå¹¶é€»è¾‘é—®é¢˜**
- è™½ç„¶æˆ‘ä»¬å®ç°äº† `_merge_macro_emission_params`ï¼Œä½†å¯èƒ½å­˜åœ¨è¾¹ç•Œæƒ…å†µ
- å½“æ–°å‚æ•°åªåŒ…å« `traffic_flow_vph` æ—¶ï¼Œåˆå¹¶é€»è¾‘å¯èƒ½å‡ºé”™

**å¯èƒ½åŸå› 3: System PromptæŒ‡å¯¼ä¸å¤Ÿæ˜ç¡®**
- Planningé˜¶æ®µçš„Promptå¯èƒ½æ²¡æœ‰æ˜ç¡®å‘Šè¯‰LLMï¼šå¢é‡æŸ¥è¯¢æ—¶åªéœ€æä¾›å˜åŒ–çš„å­—æ®µ
- LLMå¯èƒ½è¯¯ä»¥ä¸ºéœ€è¦æ˜¾å¼è¯´æ˜"ä½¿ç”¨å†å²links_data"

### éªŒè¯æ–¹æ³•
éœ€è¦æŸ¥çœ‹Planning LLMå®é™…ç”Ÿæˆçš„JSONï¼Œç¡®å®šæ˜¯å“ªä¸ªç¯èŠ‚å‡ºé”™ã€‚

---

## é—®é¢˜2: è®¡ç®—ç»“æœä¸¥é‡é”™è¯¯ ğŸ”´ **ä¸¥é‡**

### ç°è±¡
```
æŸ¥è¯¢1: 800è¾†/å°æ—¶ â†’ CO2: 8170.38 kg/h
æŸ¥è¯¢2: 1200è¾†/å°æ—¶ â†’ CO2: 3426.54 kg/h  âŒ é”™è¯¯ï¼
```

**é€»è¾‘é”™è¯¯**: è½¦æµé‡å¢åŠ 50%ï¼Œæ’æ”¾é‡åè€Œå‡å°‘58%ï¼

### æ ¹æœ¬åŸå› åˆ†æ

è¿™æ˜¯æœ€ä¸¥é‡çš„é—®é¢˜ï¼Œè¯´æ˜ä¼ é€’ç»™è®¡ç®—å™¨çš„æ•°æ®æ˜¯é”™è¯¯çš„ã€‚

**å¯èƒ½åŸå› 1: links_dataè¢«ç ´å**
- å‚æ•°åˆå¹¶è¿‡ç¨‹ä¸­ï¼Œlinks_dataçš„ç»“æ„è¢«ç ´å
- ä¾‹å¦‚ï¼šåŸæœ¬æ˜¯ `[{link_length_km: 2, traffic_flow_vph: 800, ...}]`
- å˜æˆäº†é”™è¯¯çš„æ ¼å¼æˆ–ç©ºæ•°ç»„

**å¯èƒ½åŸå› 2: å‚æ•°æ›´æ–°é€»è¾‘é”™è¯¯**
- `_update_list_items` æ–¹æ³•å¯èƒ½æ²¡æœ‰æ­£ç¡®æ›´æ–°
- æˆ–è€…æ›´æ–°åçš„å€¼æ²¡æœ‰è¢«æ­£ç¡®ä¼ é€’åˆ°è®¡ç®—å™¨

**å¯èƒ½åŸå› 3: åæ€ä¿®å¤å™¨ç ´åäº†æ•°æ®**
- éªŒè¯å¤±è´¥åï¼ŒReflectorå°è¯•ä¿®å¤
- ä¿®å¤è¿‡ç¨‹ä¸­å¯èƒ½ç”Ÿæˆäº†é”™è¯¯çš„links_data

### å½±å“
è¿™ä¼šå¯¼è‡´ç”¨æˆ·å¾—åˆ°å®Œå…¨é”™è¯¯çš„è®¡ç®—ç»“æœï¼Œä¸¥é‡å½±å“ç³»ç»Ÿå¯ä¿¡åº¦ã€‚

---

## é—®é¢˜3: å›é¡¾æ€§æŸ¥è¯¢æ— æ³•è·å–æ•°å€¼ç»“æœ âš ï¸

### ç°è±¡
```
ç”¨æˆ·: "åˆšæ‰CO2çš„ç»“æœæ˜¯å¤šå°‘ï¼Ÿ"
Agent: "å†å²è®°å½•ä¸­åªæ˜¾ç¤ºäº†å‡½æ•°è°ƒç”¨ï¼Œæ²¡æœ‰åŒ…å«å…·ä½“çš„è®¡ç®—ç»“æœæ•°å€¼"
```

### æ ¹æœ¬åŸå› åˆ†æ

**åŸå› : ä¸Šä¸‹æ–‡ç®¡ç†å™¨æ²¡æœ‰ä¿å­˜æ•°å€¼ç»“æœ**
- `ConversationContext` åªä¿å­˜äº† `SkillExecution` è®°å½•
- `SkillExecution.result` åŒ…å« `success`, `data`, `error`
- ä½† `_summarize_turn` æ–¹æ³•åªæ˜¾ç¤ºå‚æ•°ï¼Œä¸æ˜¾ç¤ºç»“æœæ•°æ®

### ä»£ç ä½ç½®
`agent/context.py` ç¬¬184-193è¡Œï¼š
```python
def _summarize_turn(self, turn: ConversationTurn) -> str:
    if not turn.skill_executions:
        return turn.assistant_response[:200]

    summaries = []
    for exec in turn.skill_executions:
        if exec.result.get("success"):
            summaries.append(f"[{exec.skill_name}: {self._summarize_params(exec.params)}]")
    return "\n".join(summaries) if summaries else turn.assistant_response[:200]
```

**é—®é¢˜**: åªæ€»ç»“äº†å‚æ•°ï¼Œæ²¡æœ‰æ€»ç»“ç»“æœæ•°æ®ã€‚

---

## é—®é¢˜4: Planningå»¶è¿Ÿè¿‡é«˜ âš ï¸

### ç°è±¡
```
å¹³å‡å»¶è¿Ÿ: 17.9ç§’
P95å»¶è¿Ÿ: 26.2ç§’
ç›®æ ‡: <5ç§’
```

è™½ç„¶ç¼“å­˜å·²å®ç°ï¼Œä½†é¦–æ¬¡æŸ¥è¯¢å»¶è¿Ÿä»ç„¶å¾ˆé«˜ã€‚

---

## ä¿®å¤è®¡åˆ’

### ä¼˜å…ˆçº§1: ä¿®å¤è®¡ç®—ç»“æœé”™è¯¯ ğŸ”´

**ä»»åŠ¡1.1: æ·»åŠ è°ƒè¯•æ—¥å¿—**
- åœ¨ `_merge_macro_emission_params` ä¸­æ·»åŠ è¯¦ç»†æ—¥å¿—
- è®°å½•åˆå¹¶å‰åçš„ links_data å†…å®¹
- ç¡®è®¤å‚æ•°æ˜¯å¦æ­£ç¡®ä¼ é€’åˆ°Skill

**ä»»åŠ¡1.2: éªŒè¯å‚æ•°åˆå¹¶é€»è¾‘**
- åˆ›å»ºå•å…ƒæµ‹è¯•éªŒè¯ `_update_list_items` æ–¹æ³•
- æµ‹è¯•åœºæ™¯ï¼š
  - æ›´æ–° traffic_flow_vph
  - æ›´æ–° avg_speed_kph
  - æ›´æ–° fleet_mix
  - åŒæ—¶æ›´æ–°å¤šä¸ªå­—æ®µ

**ä»»åŠ¡1.3: æ£€æŸ¥Reflectorä¿®å¤é€»è¾‘**
- ç¡®è®¤Reflectoråœ¨ä¿®å¤æ—¶ä¸ä¼šç ´ålinks_data
- å¦‚æœPlanningç”Ÿæˆäº†é”™è¯¯çš„links_dataï¼ˆå­—ç¬¦ä¸²ï¼‰ï¼ŒReflectoråº”è¯¥å¦‚ä½•å¤„ç†ï¼Ÿ

**ä»»åŠ¡1.4: æ·»åŠ å‚æ•°éªŒè¯**
- åœ¨Skillæ‰§è¡Œå‰ï¼Œæ‰“å°å®Œæ•´çš„links_data
- ç¡®è®¤æ•°æ®æ ¼å¼æ­£ç¡®

### ä¼˜å…ˆçº§2: ä¿®å¤PlanningéªŒè¯å¤±è´¥ âš ï¸

**ä»»åŠ¡2.1: ä¼˜åŒ–System Prompt**
- åœ¨å¢é‡å¯¹è¯ç¤ºä¾‹ä¸­æ˜ç¡®è¯´æ˜ï¼š
  ```
  ç”¨æˆ·: "æ”¹æˆ1200è¾†"
  æ­£ç¡®å“åº”: {"traffic_flow_vph": 1200}  // åªæä¾›å˜åŒ–çš„å­—æ®µ
  é”™è¯¯å“åº”: {"links_data": "ä»ä¸Šä¸‹æ–‡è·å–"}  // ä¸è¦è¿™æ ·åšï¼
  ```

**ä»»åŠ¡2.2: å¢å¼ºå‚æ•°åˆå¹¶å¥å£®æ€§**
- å¦‚æœPlanningç”Ÿæˆäº† `{"links_data": "..."}` å­—ç¬¦ä¸²
- å‚æ•°åˆå¹¶åº”è¯¥å¿½ç•¥è¿™ä¸ªé”™è¯¯çš„å­—æ®µï¼Œä½¿ç”¨å†å²çš„links_data

**ä»»åŠ¡2.3: æ”¹è¿›Reflector**
- å½“æ£€æµ‹åˆ° `links_data` æ˜¯å­—ç¬¦ä¸²æ—¶
- è‡ªåŠ¨ä»å†å²å‚æ•°ä¸­æ¢å¤æ­£ç¡®çš„links_data

### ä¼˜å…ˆçº§3: æ”¹è¿›å›é¡¾æ€§æŸ¥è¯¢ âš ï¸

**ä»»åŠ¡3.1: å¢å¼ºä¸Šä¸‹æ–‡æ€»ç»“**
- ä¿®æ”¹ `_summarize_turn` æ–¹æ³•
- åŒ…å«å…³é”®çš„è®¡ç®—ç»“æœæ•°å€¼
- ä¾‹å¦‚ï¼š`[calculate_macro_emission: CO2=8170.38 kg/h, PM2.5=0.0665 kg/h]`

**ä»»åŠ¡3.2: ä¼˜åŒ–Synthesis Prompt**
- ç¡®ä¿Synthesisé˜¶æ®µèƒ½å¤Ÿè®¿é—®å®Œæ•´çš„æ•°å€¼ç»“æœ
- åœ¨ä¸Šä¸‹æ–‡ä¸­åŒ…å«ç»“æœæ‘˜è¦

### ä¼˜å…ˆçº§4: æ€§èƒ½ä¼˜åŒ– ğŸ’¡

**ä»»åŠ¡4.1: åˆ†æå»¶è¿Ÿæ¥æº**
- Planning LLMè°ƒç”¨: ~8-10ç§’
- Synthesis LLMè°ƒç”¨: ~5-7ç§’
- Skillæ‰§è¡Œ: ~1-2ç§’
- åæ€ä¿®å¤ï¼ˆå¦‚æœéœ€è¦ï¼‰: +8-10ç§’

**ä»»åŠ¡4.2: ä¼˜åŒ–ç­–ç•¥**
- ä½¿ç”¨æ›´å¿«çš„æ¨¡å‹ï¼ˆHaikuï¼‰å¤„ç†ç®€å•æŸ¥è¯¢
- å¹¶è¡ŒåŒ–Planningå’Œæ•°æ®åŠ è½½
- ä¼˜åŒ–Prompté•¿åº¦

---

## å®æ–½é¡ºåº

### ç¬¬ä¸€æ­¥: è¯Šæ–­é—®é¢˜ï¼ˆç«‹å³æ‰§è¡Œï¼‰
1. æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
2. è¿è¡Œæµ‹è¯•ç”¨ä¾‹ï¼Œæ•è·å®Œæ•´çš„æ‰§è¡Œæµç¨‹
3. ç¡®è®¤é—®é¢˜çš„ç¡®åˆ‡åŸå› 

### ç¬¬äºŒæ­¥: ä¿®å¤æ ¸å¿ƒé—®é¢˜ï¼ˆä»Šå¤©å®Œæˆï¼‰
1. ä¿®å¤è®¡ç®—ç»“æœé”™è¯¯ï¼ˆä¼˜å…ˆçº§1ï¼‰
2. ä¿®å¤PlanningéªŒè¯å¤±è´¥ï¼ˆä¼˜å…ˆçº§2ï¼‰

### ç¬¬ä¸‰æ­¥: æ”¹è¿›ç”¨æˆ·ä½“éªŒï¼ˆæ˜å¤©å®Œæˆï¼‰
1. æ”¹è¿›å›é¡¾æ€§æŸ¥è¯¢ï¼ˆä¼˜å…ˆçº§3ï¼‰
2. æ€§èƒ½ä¼˜åŒ–ï¼ˆä¼˜å…ˆçº§4ï¼‰

---

## æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•1: åŸºæœ¬å¢é‡æŸ¥è¯¢
```
1. "2å…¬é‡Œé“è·¯ï¼Œ40km/hï¼Œ800è¾†/å°æ—¶ï¼Œ70%å°æ±½è½¦30%å…¬äº¤è½¦ï¼ŒCO2"
2. "æ”¹æˆ1000è¾†"
é¢„æœŸ:
  - PlanningéªŒè¯é€šè¿‡
  - CO2æ’æ”¾é‡åº”è¯¥æ˜¯ç¬¬ä¸€æ¬¡çš„ 1000/800 = 1.25å€
```

### æµ‹è¯•2: å¤šæ¬¡å¢é‡ä¿®æ”¹
```
1. "2å…¬é‡Œé“è·¯ï¼Œ40km/hï¼Œ800è¾†/å°æ—¶ï¼Œ70%å°æ±½è½¦30%å…¬äº¤è½¦ï¼ŒCO2"
2. "PM2.5å‘¢ï¼Ÿ"
3. "æ”¹æˆ1200è¾†"
4. "é€Ÿåº¦æ”¹æˆ60km/h"
é¢„æœŸ: æ¯æ¬¡ä¿®æ”¹éƒ½åº”è¯¥æ­£ç¡®ç´¯ç§¯
```

### æµ‹è¯•3: å›é¡¾æ€§æŸ¥è¯¢
```
1. "2å…¬é‡Œé“è·¯ï¼Œ40km/hï¼Œ800è¾†/å°æ—¶ï¼Œ70%å°æ±½è½¦30%å…¬äº¤è½¦ï¼ŒCO2"
2. "åˆšæ‰CO2çš„ç»“æœæ˜¯å¤šå°‘ï¼Ÿ"
é¢„æœŸ: åº”è¯¥èƒ½å¤Ÿå‡†ç¡®å›ç­”æ•°å€¼
```

---

## éœ€è¦æ£€æŸ¥çš„æ–‡ä»¶

1. **agent/context.py**
   - `merge_params` æ–¹æ³•
   - `_merge_macro_emission_params` æ–¹æ³•
   - `_update_list_items` æ–¹æ³•
   - `_summarize_turn` æ–¹æ³•

2. **agent/core.py**
   - `_enrich_plan_for_validation` æ–¹æ³•
   - `_plan_with_validation` æ–¹æ³•

3. **agent/reflector.py**
   - `_llm_based_fix` æ–¹æ³•
   - ç¡®è®¤ä¿®å¤é€»è¾‘ä¸ä¼šç ´ålinks_data

4. **agent/prompts/system.py**
   - å¢é‡å¯¹è¯ç¤ºä¾‹
   - ç¡®ä¿æŒ‡å¯¼è¶³å¤Ÿæ˜ç¡®

5. **skills/macro_emission/skill.py**
   - `execute` æ–¹æ³•
   - ç¡®è®¤å‚æ•°æ¥æ”¶æ­£ç¡®

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨

**ç«‹å³æ‰§è¡Œ**:
1. åˆ›å»ºè°ƒè¯•è„šæœ¬ï¼Œé‡ç°é—®é¢˜
2. æ·»åŠ è¯¦ç»†æ—¥å¿—ï¼Œè¿½è¸ªå‚æ•°æµè½¬
3. ç¡®è®¤é—®é¢˜çš„ç¡®åˆ‡åŸå› 

**ç­‰å¾…ç¡®è®¤åæ‰§è¡Œ**:
æ ¹æ®è¯Šæ–­ç»“æœï¼Œå®æ–½ç›¸åº”çš„ä¿®å¤æ–¹æ¡ˆã€‚

---

**çŠ¶æ€**: åˆ†æå®Œæˆï¼Œç­‰å¾…è¯Šæ–­å’Œä¿®å¤
**é¢„è®¡ä¿®å¤æ—¶é—´**: 2-4å°æ—¶
**é£é™©ç­‰çº§**: é«˜ï¼ˆè®¡ç®—ç»“æœé”™è¯¯ä¼šä¸¥é‡å½±å“ç³»ç»Ÿå¯ä¿¡åº¦ï¼‰
