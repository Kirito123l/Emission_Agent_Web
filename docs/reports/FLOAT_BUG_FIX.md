# 浮点数Bug修复报告

**日期**: 2026-01-23
**Bug ID**: FLOAT-001
**严重程度**: 致命

## 问题根因

CSV文件中的Speed列是**浮点数类型**（float64），而不是整数。

### 错误的代码
```python
speed_code = str(row[self.COL_SPEED])  # 7705.0 -> "7705.0"
road_type = int(speed_code[-1])  # "7705.0"[-1] = "0" ❌
```

### 问题分析
- Speed值：`7705.0` (float)
- 转字符串：`"7705.0"`
- 取最后一位：`"0"` (小数点后的0，而不是道路类型5)
- 结果：`road_type_in_data = 0`，永远不匹配4或5

## 修复方案

### 正确的代码
```python
speed_code = str(int(row[self.COL_SPEED]))  # 7705.0 -> 7705 -> "7705"
road_type = int(speed_code[-1])  # "7705"[-1] = "5" ✓
```

### 修复步骤
1. 先将浮点数转换为整数：`int(7705.0)` → `7705`
2. 再转换为字符串：`str(7705)` → `"7705"`
3. 然后解析：`"7705"[-1]` → `"5"` ✓

## 修复效果

### 修复前
```
查询：2020年小汽车CO2，快速路
结果：未找到匹配数据 ❌
原因：road_type_in_data = 0，永远不匹配4或5
```

### 修复后
```
查询：2020年小汽车CO2，快速路
结果：成功！73个数据点 ✓
速度范围：5-77 mph
道路类型：4（快速路）
```

## 测试验证

```bash
$ python test_calculator.py
=== 测试查询 ===

状态: success
成功！数据点数: 73
速度范围: {'min_mph': 5, 'max_mph': 77, 'min_kph': 8.0, 'max_kph': 123.9}
```

## 代码变更

**文件**: `skills/emission_factors/calculator.py`

**行号**: 第122行

**变更**:
```diff
- speed_code = str(row[self.COL_SPEED])
+ speed_code = str(int(row[self.COL_SPEED]))  # 先转int再转str
```

## 经验教训

1. **数据类型假设要验证**：不要假设CSV列的数据类型
2. **添加类型转换**：处理数值时先转换为预期类型
3. **调试输出很重要**：通过打印中间值快速定位问题
4. **测试边界情况**：浮点数、字符串、整数等不同类型

## 相关Bug

这个bug与之前的SPEED-001（速度编码格式理解错误）是两个独立的问题：
- SPEED-001：理解错了编码格式（504 = 50 mph ❌）
- FLOAT-001：没有处理浮点数类型（7705.0 -> "7705.0" ❌）

两个bug都已修复。

---

**修复人**: Claude Sonnet 4.5
**状态**: ✅ 已修复并验证
