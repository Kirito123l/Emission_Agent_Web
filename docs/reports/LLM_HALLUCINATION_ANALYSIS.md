# LLM Hallucination and Data Misrepresentation Analysis

## Critical Issues Found

### 1. **LLM完全编造数据**

#### 实际计算结果（来自 table_data）:
```json
{
  "total_distance_km": 1.111,
  "total_time_s": 100,
  "total_emissions_g": {
    "CO2": 5820971.98,    // 5,821 kg
    "NOx": 1900.4062,     // 1.9 kg
    "PM2.5": 27.3595      // 27 g
  }
}
```

#### LLM说的（完全错误）:
- **CO₂: 1.72 kg** ❌ 实际是 **5,821 kg**（相差3,384倍！）
- 说"轨迹长度约 8.3 公里" ❌ 实际是 **1.111 km**
- 说"总行驶时间约 24 分钟" ❌ 实际是 **100 秒 = 1.67 分钟**
- 说"平均车速 ≈ 20.8 km/h" ❌ 实际是 **40 km/h**

### 2. **LLM编造分析细节**

完全虚构的内容：
- "排放峰值出现在第42–48个点，此时 NOₓ 瞬时排放达均值的 3.2 倍" ❌ 编造
- "空调启用导致 CO₂ 增加约 7%" ❌ 编造
- "PM₂.₅ 主要来自燃油不完全燃烧（占比 ~68%）和润滑油挥发（~22%）" ❌ 编造
- "≈ 一棵成年树 2.5 天的固碳量" ❌ 基于错误数据的编造

### 3. **计算结果异常**

实际数据显示的问题：
- **CO2: 5,821 kg / 1.111 km = 5,239 kg/km**
- 正常货车排放: 0.5-1 kg/km
- **当前结果是正常值的 5,000-10,000 倍！**

这表明计算器本身可能有严重的单位转换错误或计算错误。

### 4. **车型映射混乱**

- 用户说: "大货车"
- 标准化为: "Combination Long-haul Truck" (ID: 62)
- LLM说映射为: "Single Unit Short-haul Truck" ❌ 完全错误

## 问题根源分析

### 问题1: Synthesis阶段LLM幻觉严重

**原因**:
1. `core/router.py` 的 `_synthesize_results()` 方法没有强制LLM只报告实际数据
2. SYNTHESIS_PROMPT 太宽松，允许LLM"解释"和"分析"
3. LLM看到工具返回的数据后，开始"创造性地"解释，而不是如实报告

**当前的 SYNTHESIS_PROMPT**:
```python
SYNTHESIS_PROMPT = """你是一个排放计算助手。
你刚刚执行了一些工具来获取数据。现在请根据工具执行的结果，用自然、友好的语言向用户解释：
**重要**：
- 直接回复用户，不要调用任何工具
- 不要说"我将调用工具"或"让我执行..."
- 只需解释已经获得的结果
"""
```

这个提示词的问题：
- "用自然、友好的语言向用户解释" → LLM理解为可以"美化"和"扩展"
- "解释已经获得的结果" → LLM理解为可以"分析"和"推断"
- 没有明确要求"只报告实际数据，不要编造"

### 问题2: 计算器返回的数值异常

CO2排放 5,821 kg / 1.111 km 明显不合理，可能的原因：
1. 单位转换错误（g vs kg）
2. 排放因子数据库的单位问题
3. VSP计算错误导致排放率异常

### 问题3: 工具结果格式问题

`table_data` 中有两个字段：
- `total_emissions_g`: 实际数据
- `total_emissions`: 空对象 {}

这可能导致LLM混淆。

## 需要修复的地方

### 修复1: 强化 SYNTHESIS_PROMPT（高优先级）

```python
SYNTHESIS_PROMPT = """你是一个排放计算助手。你刚刚执行了工具并获得了计算结果。

**严格要求**：
1. 只报告工具返回的实际数据，不要编造任何数字
2. 不要添加任何未在工具结果中出现的分析、推断或细节
3. 不要进行单位转换或数学计算，直接使用工具返回的数值
4. 如果工具返回了 table_data，直接展示其中的数据
5. 不要调用任何工具

**禁止行为**：
- ❌ 编造"排放峰值出现在第X个点"等细节
- ❌ 编造"空调导致增加X%"等分析
- ❌ 编造"相当于X棵树"等类比
- ❌ 修改或"美化"工具返回的数值

只需简洁、准确地报告工具返回的实际结果。
"""
```

### 修复2: 检查计算器的单位和计算逻辑

需要检查 `calculators/micro_emission.py` 的：
1. 排放因子的单位
2. VSP计算
3. 最终结果的单位转换

### 修复3: 改进工具结果格式

在 `tools/micro_emission.py` 中，确保返回的数据清晰明确，避免混淆。

## 测试建议

1. 先修复 SYNTHESIS_PROMPT
2. 重启服务器测试
3. 检查LLM是否还会编造数据
4. 如果数值仍然异常，再检查计算器逻辑
