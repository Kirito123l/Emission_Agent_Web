# 文件预分析重构 - 实施总结

## 实施日期
2026-02-02

## 核心问题
Planning 阶段 LLM 看不到文件内容，导致：
- 任务类型判断不准确（把宏观文件当微观处理）
- 追问不准确（文件已有车型比例还追问用户）
- 使用 query_knowledge 去"查"文件格式

## 解决方案
在 Planning 之前增加文件预分析步骤，让 LLM 能看到文件内容。

## 实施的修改

### 1. 新建 `skills/common/file_analyzer.py`
- 创建 `FileAnalyzer` 类
- 实现 `analyze()` 方法：分析文件结构、判断任务类型、识别列名
- 实现 `format_for_llm()` 方法：将分析结果格式化为 LLM 可读文本
- 保留旧的 `analyze_file_structure()` 函数以保持向后兼容

**核心功能**：
- 自动判断任务类型（微观 vs 宏观）
- 识别关键列（时间、速度、加速度、路段ID、长度、流量、车型比例等）
- 检测车型比例列（对宏观排放很重要）
- 生成警告信息（如日流量需转换、速度单位异常等）
- 返回置信度评分

### 2. 修改 `agent/context.py`
- 在 `ConversationContext.__init__()` 中添加 `file_analysis` 字段
- 用于保存文件分析结果，供后续使用

### 3. 修改 `agent/core.py`
- 导入 `file_analyzer` 和 `re` 模块
- 在 `chat()` 方法中，Planning 之前添加文件预分析逻辑：
  1. 检测消息中是否包含"文件已上传，路径:"
  2. 提取文件路径
  3. 调用 `file_analyzer.analyze()` 分析文件
  4. 将分析结果格式化并添加到用户消息中
  5. 保存分析结果到 context
  6. 使用增强后的消息进行 Planning

### 4. 简化 `agent/prompts/system.py`
- 移除复杂的任务类型判断规则（原来需要 LLM 根据列名特征判断）
- 移除冗长的文件处理规则
- 添加基于文件分析结果的简单规则：
  - 如果分析显示是微观排放 → 使用 calculate_micro_emission
  - 如果分析显示是宏观排放 → 使用 calculate_macro_emission
  - 如果文件已有车型比例 → 不追问车型
  - 如果文件没有车型比例 → 询问是否使用默认值

### 5. 更新 `skills/common/__init__.py`
- 导出新的 `FileAnalyzer` 类和 `file_analyzer` 实例
- 保留旧的 `analyze_file_structure` 函数导出（向后兼容）

## 工作流程对比

### 改进前
```
用户上传文件
  ↓
Planning (LLM 只看到文件路径，不知道内容)
  ↓
LLM 凭经验猜测任务类型和缺失参数
  ↓
可能选错 Skill 或生成不准确的追问
  ↓
Skill 执行时才读取文件
```

### 改进后
```
用户上传文件
  ↓
文件预分析 (读取列名、判断类型、识别车型比例)
  ↓
将分析结果添加到消息中
  ↓
Planning (LLM 看到完整的文件分析结果)
  ↓
LLM 基于分析结果做出准确决策
  ↓
生成正确的 Skill 调用和精准的追问
  ↓
Skill 执行
```

## 预期效果

### ✅ 解决的问题
1. **任务类型判断准确**：不会再把宏观文件当微观处理
2. **追问更精准**：
   - 宏观文件有车型比例 → 不追问车型
   - 宏观文件无车型比例 → 询问是否使用默认值
   - 微观文件 → 追问车型
3. **不再使用 query_knowledge**：文件分析已经提供了所需信息
4. **追问质量提升**：追问中包含文件分析结果，用户能看到系统识别了什么

### ✅ 性能优化
- 减少不必要的 LLM 调用（不需要重试）
- 减少 System Prompt 长度（从 627 行简化）
- 提升用户体验（更快、更准确的响应）

## 测试建议

### 测试用例 1：宏观文件（有车型比例）
- 上传包含 `Car%`, `Bus%` 等列的宏观文件
- 期望：不追问车型，直接计算

### 测试用例 2：宏观文件（无车型比例）
- 上传只有 link_id, length, flow, speed 的宏观文件
- 期望：追问是否使用默认车型比例

### 测试用例 3：微观文件
- 上传包含 time, speed, acceleration 的微观文件
- 期望：追问车型

### 测试用例 4：用户直接指定参数
- 上传文件并在消息中说"计算小汽车的CO2排放"
- 期望：不追问，直接计算

## 向后兼容性

- ✅ 保留了旧的 `analyze_file_structure()` 函数
- ✅ 现有的 excel_handler 和 column_mapper 代码无需修改
- ✅ 新功能是增量添加，不影响现有功能

## 文件清单

| 文件 | 操作 | 说明 |
|------|------|------|
| `skills/common/file_analyzer.py` | **重写** | 新的 FileAnalyzer 类 + 向后兼容的旧函数 |
| `skills/common/__init__.py` | **修改** | 导出新类和实例 |
| `agent/context.py` | **修改** | 添加 file_analysis 字段 |
| `agent/core.py` | **修改** | 添加文件预分析逻辑 |
| `agent/prompts/system.py` | **修改** | 简化任务类型判断和文件处理规则 |

## 下一步

1. 重启服务器测试
2. 使用不同类型的文件测试
3. 观察 Planning 阶段的决策是否准确
4. 检查追问质量是否提升
5. 监控性能指标（响应时间、成功率）

## 注意事项

- 文件预分析是轻量级的，只读取列名和前3行数据，不进行完整计算
- 分析结果会被添加到用户消息中，会增加一些 Token 消耗（约 200-300 tokens）
- 但这个消耗是值得的，因为可以避免错误的 Planning 和重试
