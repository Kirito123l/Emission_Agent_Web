# EmissionAgent å››é¡¹æ ¸å¿ƒä¼˜åŒ–ä»»åŠ¡

## é¡¹ç›®èƒŒæ™¯

è¿™æ˜¯ä¸€ä¸ªåŸºäºAgent-Skillæ¶æ„çš„æ™ºèƒ½æœºåŠ¨è½¦æ’æ”¾è®¡ç®—ç³»ç»Ÿã€‚å½“å‰éœ€è¦å®Œæˆå››é¡¹ä¼˜åŒ–ä»¥æå‡ç”¨æˆ·ä½“éªŒã€‚

è¯·å…ˆé˜…è¯»ä»¥ä¸‹æ–‡ä»¶äº†è§£é¡¹ç›®æ¶æ„ï¼š
- `ARCHITECTURE.md` - ç³»ç»Ÿæ¶æ„æ–‡æ¡£
- `README.md` - é¡¹ç›®è¯´æ˜
- `agent/core.py` - Agentæ ¸å¿ƒé€»è¾‘
- `agent/learner.py` - å­¦ä¹ æœºåˆ¶
- `api/routes.py` - APIè·¯ç”±
- `api/session.py` - ä¼šè¯ç®¡ç†
- `web/app.js` - å‰ç«¯é€»è¾‘

---

## ä»»åŠ¡ä¸€ï¼šæµå¼è¾“å‡º (Streaming)

### ç›®æ ‡
ç”¨æˆ·å‘é€æ¶ˆæ¯åï¼Œç«‹å³å¼€å§‹æ˜¾ç¤ºå“åº”ï¼ˆæ€è€ƒçŠ¶æ€ã€è¿›åº¦ã€é€å­—è¾“å‡ºï¼‰ï¼Œè€Œä¸æ˜¯ç­‰å¾…å…¨éƒ¨å®Œæˆåä¸€æ¬¡æ€§è¿”å›ã€‚

### å½“å‰é—®é¢˜
- ç”¨æˆ·éœ€è¦ç­‰å¾…20-40ç§’æ‰èƒ½çœ‹åˆ°ä»»ä½•å“åº”
- æœŸé—´æ²¡æœ‰ä»»ä½•åé¦ˆï¼Œç”¨æˆ·ä¸çŸ¥é“ç³»ç»Ÿæ˜¯å¦åœ¨å·¥ä½œ

### å®ç°è¦æ±‚

#### 1. åç«¯ï¼šæ–°å¢æµå¼APIç«¯ç‚¹

åœ¨ `api/routes.py` ä¸­æ·»åŠ ï¼š

```python
from fastapi.responses import StreamingResponse
import json

@router.post("/chat/stream")
async def chat_stream(
    message: str = Form(...),
    session_id: str = Form(None),
    file: UploadFile = File(None)
):
    """æµå¼èŠå¤©æ¥å£"""
    
    async def generate():
        # 1. å‘é€"æ€è€ƒä¸­"çŠ¶æ€
        yield json.dumps({
            "type": "status", 
            "content": "æ­£åœ¨ç†è§£æ‚¨çš„é—®é¢˜..."
        }) + "\n"
        
        # 2. è·å–æˆ–åˆ›å»ºä¼šè¯
        session = session_manager.get_or_create(session_id)
        
        # 3. å¤„ç†æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰
        if file:
            yield json.dumps({
                "type": "status", 
                "content": "æ­£åœ¨å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶..."
            }) + "\n"
            # ä¿å­˜æ–‡ä»¶é€»è¾‘...
        
        # 4. Planningé˜¶æ®µ
        yield json.dumps({
            "type": "status", 
            "content": "æ­£åœ¨åˆ†æä»»åŠ¡..."
        }) + "\n"
        
        # 5. æ‰§è¡ŒSkill
        # è¿™é‡Œéœ€è¦ä¿®æ”¹Agentçš„chatæ–¹æ³•ï¼Œä½¿å…¶æ”¯æŒç”Ÿæˆå™¨æ¨¡å¼
        # æˆ–è€…å°†Agentçš„æ‰§è¡Œæ‹†åˆ†ä¸ºå¤šä¸ªæ­¥éª¤
        
        try:
            # è°ƒç”¨Agentå¤„ç†ï¼ˆéœ€è¦ä¿®æ”¹ä¸ºæ”¯æŒè¿›åº¦å›è°ƒï¼‰
            result = await asyncio.to_thread(
                session.agent.chat_with_progress,
                message,
                progress_callback=lambda p: None  # è¿›åº¦å›è°ƒ
            )
            
            # 6. æµå¼è¾“å‡ºæœ€ç»ˆæ–‡æœ¬
            # å°†å›å¤æ‹†åˆ†ä¸ºchunksé€ä¸ªå‘é€
            reply_text = result.get('reply', '')
            chunk_size = 20  # æ¯æ¬¡å‘é€20ä¸ªå­—ç¬¦
            for i in range(0, len(reply_text), chunk_size):
                chunk = reply_text[i:i+chunk_size]
                yield json.dumps({
                    "type": "text",
                    "content": chunk
                }) + "\n"
                await asyncio.sleep(0.05)  # æ¨¡æ‹Ÿæ‰“å­—æ•ˆæœ
            
            # 7. å‘é€å›¾è¡¨/è¡¨æ ¼æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
            if result.get('chart_data'):
                yield json.dumps({
                    "type": "chart",
                    "content": result['chart_data']
                }) + "\n"
            
            if result.get('table_data'):
                yield json.dumps({
                    "type": "table",
                    "content": result['table_data']
                }) + "\n"
            
            # 8. å‘é€å®Œæˆä¿¡å·
            yield json.dumps({
                "type": "done",
                "session_id": session.session_id
            }) + "\n"
            
        except Exception as e:
            yield json.dumps({
                "type": "error",
                "content": f"å¤„ç†å‡ºé”™: {str(e)}"
            }) + "\n"
    
    return StreamingResponse(
        generate(),
        media_type="text/event-stream",
        headers={
            "Cache-Control": "no-cache",
            "Connection": "keep-alive",
        }
    )
```

#### 2. å‰ç«¯ï¼šæ”¯æŒæµå¼æ¥æ”¶

åœ¨ `web/app.js` ä¸­ä¿®æ”¹ `sendMessage` å‡½æ•°ï¼š

```javascript
async function sendMessageStream(message, file = null) {
    // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
    appendMessage('user', message);
    
    // åˆ›å»ºåŠ©æ‰‹æ¶ˆæ¯å®¹å™¨ï¼ˆç”¨äºæµå¼å¡«å……ï¼‰
    const assistantMsgId = 'msg-' + Date.now();
    const msgContainer = createAssistantMessageContainer(assistantMsgId);
    
    // æ„å»ºFormData
    const formData = new FormData();
    formData.append('message', message);
    formData.append('session_id', currentSessionId || '');
    if (file) {
        formData.append('file', file);
    }
    
    try {
        const response = await fetch('/chat/stream', {
            method: 'POST',
            body: formData
        });
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        
        let fullText = '';
        
        while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n').filter(line => line.trim());
            
            for (const line of lines) {
                try {
                    const data = JSON.parse(line);
                    
                    switch (data.type) {
                        case 'status':
                            // æ˜¾ç¤ºçŠ¶æ€æç¤º
                            showTypingIndicator(data.content);
                            break;
                            
                        case 'text':
                            // è¿½åŠ æ–‡æœ¬å†…å®¹
                            fullText += data.content;
                            updateMessageContent(assistantMsgId, fullText);
                            break;
                            
                        case 'chart':
                            // æ¸²æŸ“å›¾è¡¨
                            renderChart(data.content, assistantMsgId);
                            break;
                            
                        case 'table':
                            // æ¸²æŸ“è¡¨æ ¼
                            renderTable(data.content, assistantMsgId);
                            break;
                            
                        case 'done':
                            // å®Œæˆï¼Œæ›´æ–°session_id
                            hideTypingIndicator();
                            if (data.session_id) {
                                currentSessionId = data.session_id;
                            }
                            break;
                            
                        case 'error':
                            // æ˜¾ç¤ºé”™è¯¯
                            showError(data.content);
                            break;
                    }
                } catch (e) {
                    console.error('è§£ææµå¼æ•°æ®å¤±è´¥:', e);
                }
            }
        }
        
    } catch (error) {
        console.error('æµå¼è¯·æ±‚å¤±è´¥:', error);
        showError('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
}

function createAssistantMessageContainer(msgId) {
    const container = document.createElement('div');
    container.id = msgId;
    container.className = 'message assistant';
    container.innerHTML = '<div class="message-content"></div>';
    messagesContainer.appendChild(container);
    return container;
}

function updateMessageContent(msgId, content) {
    const container = document.getElementById(msgId);
    if (container) {
        const contentDiv = container.querySelector('.message-content');
        contentDiv.innerHTML = marked.parse(content);
    }
}

function showTypingIndicator(text) {
    let indicator = document.getElementById('typing-indicator');
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'typing-indicator';
        indicator.className = 'typing-indicator';
        messagesContainer.appendChild(indicator);
    }
    indicator.textContent = text;
    indicator.style.display = 'block';
}

function hideTypingIndicator() {
    const indicator = document.getElementById('typing-indicator');
    if (indicator) {
        indicator.style.display = 'none';
    }
}
```

#### 3. æ·»åŠ CSSæ ·å¼

åœ¨ `web/styles.css` ä¸­æ·»åŠ ï¼š

```css
.typing-indicator {
    padding: 8px 16px;
    color: #666;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.typing-indicator::before {
    content: '';
    width: 8px;
    height: 8px;
    background: #3b82f6;
    border-radius: 50%;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 0.4; }
    50% { opacity: 1; }
}
```

### éªŒæ”¶æ ‡å‡†
- [ ] ç”¨æˆ·å‘é€æ¶ˆæ¯å1ç§’å†…çœ‹åˆ°"æ­£åœ¨ç†è§£æ‚¨çš„é—®é¢˜..."
- [ ] Planningå®Œæˆåæ˜¾ç¤º"æ­£åœ¨æ‰§è¡Œ..."
- [ ] å›å¤æ–‡æœ¬é€å­—/é€æ®µæ˜¾ç¤º
- [ ] å›¾è¡¨åœ¨æ–‡æœ¬å®Œæˆåæ¸²æŸ“
- [ ] åŸæœ‰çš„éæµå¼æ¥å£ `/chat` ä¿æŒå¯ç”¨ä½œä¸ºé™çº§æ–¹æ¡ˆ

---

## ä»»åŠ¡äºŒï¼šFew-shotå­¦ä¹ æ¥å…¥

### ç›®æ ‡
å°†Learneræ”¶é›†çš„æˆåŠŸæ¡ˆä¾‹æ³¨å…¥åˆ°Planningçš„Promptä¸­ï¼Œæé«˜é¦–æ¬¡PlanningæˆåŠŸç‡ã€‚

### å½“å‰é—®é¢˜
- `agent/learner.py` å·²ç»å®ç°äº†æ¡ˆä¾‹æ”¶é›†å’Œç¤ºä¾‹ç”Ÿæˆ
- ä½† `agent/core.py` çš„Planningæµç¨‹æ²¡æœ‰ä½¿ç”¨è¿™äº›æ•°æ®
- å¯¼è‡´æ¯æ¬¡Planningéƒ½ä»é›¶å¼€å§‹ï¼Œé‡å¤çŠ¯åŒæ ·çš„é”™è¯¯

### å®ç°è¦æ±‚

#### 1. ä¿®æ”¹ `agent/core.py`

æ‰¾åˆ° `_plan_with_validation` æˆ–ç±»ä¼¼çš„Planningæ–¹æ³•ï¼Œæ·»åŠ Few-shotç¤ºä¾‹æ³¨å…¥ï¼š

```python
def _plan_with_validation(self, user_input: str, context: Context) -> Dict:
    """å¸¦éªŒè¯çš„Planningï¼ŒåŒ…å«Few-shotç¤ºä¾‹"""
    
    # 1. å¿«é€Ÿæ„å›¾æ£€æµ‹ï¼Œç¡®å®šå¯èƒ½çš„Skill
    inferred_skill = self._quick_intent_detection(user_input)
    
    # 2. ä»Learnerè·å–ç›¸å…³ç¤ºä¾‹ ã€æ–°å¢ã€‘
    few_shot_examples = []
    if self._learner and inferred_skill:
        few_shot_examples = self._learner.get_relevant_examples(
            skill_name=inferred_skill,
            query=user_input,
            limit=3
        )
    
    # 3. æ„å»ºåŒ…å«ç¤ºä¾‹çš„Prompt ã€ä¿®æ”¹ã€‘
    planning_prompt = self._build_planning_prompt_with_examples(
        user_input=user_input,
        context=context,
        few_shot_examples=few_shot_examples
    )
    
    # 4. è°ƒç”¨LLMç”Ÿæˆè®¡åˆ’
    plan = self._agent_llm.chat_json(planning_prompt)
    
    # 5. éªŒè¯å’Œåç»­æµç¨‹ä¿æŒä¸å˜...
    return plan


def _build_planning_prompt_with_examples(
    self, 
    user_input: str, 
    context: Context,
    few_shot_examples: List[Dict]
) -> str:
    """æ„å»ºåŒ…å«Few-shotç¤ºä¾‹çš„Planning Prompt"""
    
    # åŸºç¡€System Prompt
    base_prompt = self._get_system_prompt()
    
    # Few-shotç¤ºä¾‹éƒ¨åˆ†
    examples_section = ""
    if few_shot_examples:
        examples_section = """
## å‚è€ƒæ¡ˆä¾‹

ä»¥ä¸‹æ˜¯ç±»ä¼¼è¯·æ±‚çš„æ­£ç¡®å¤„ç†æ–¹å¼ï¼Œè¯·å‚è€ƒè¿™äº›æ¡ˆä¾‹çš„æ ¼å¼å’Œå‚æ•°æå–æ–¹å¼ï¼š

"""
        for i, ex in enumerate(few_shot_examples, 1):
            examples_section += f"""
### æ¡ˆä¾‹ {i}
ç”¨æˆ·è¾“å…¥: {ex.get('user_input', '')}
æ­£ç¡®è®¡åˆ’:
```json
{json.dumps(ex.get('plan', {}), ensure_ascii=False, indent=2)}
```
---
"""
    
    # ä¸Šä¸‹æ–‡æ‘˜è¦
    context_summary = context.get_summary() if context else "æ— å†å²å¯¹è¯"
    
    # ç»„è£…å®Œæ•´Prompt
    full_prompt = f"""
{base_prompt}

{examples_section}

## å½“å‰è¯·æ±‚

**ç”¨æˆ·è¾“å…¥**: {user_input}

**å¯¹è¯ä¸Šä¸‹æ–‡**: {context_summary}

è¯·æ ¹æ®ç”¨æˆ·è¾“å…¥ç”Ÿæˆæ‰§è¡Œè®¡åˆ’ã€‚è¾“å‡ºæ ¼å¼ä¸ºJSONï¼š
```json
{{
    "skill": "skill_name",
    "params": {{...}},
    "needs_clarification": false,
    "clarification_message": null
}}
```
"""
    return full_prompt
```

#### 2. ç¡®ä¿Learnerçš„ `get_relevant_examples` æ–¹æ³•å¯ç”¨

æ£€æŸ¥ `agent/learner.py`ï¼Œç¡®ä¿æœ‰å¦‚ä¸‹æ–¹æ³•ï¼ˆå¦‚æœæ²¡æœ‰åˆ™æ·»åŠ ï¼‰ï¼š

```python
def get_relevant_examples(
    self, 
    skill_name: str = None,
    query: str = None,
    limit: int = 3
) -> List[Dict]:
    """è·å–ä¸å½“å‰æŸ¥è¯¢ç›¸å…³çš„æˆåŠŸæ¡ˆä¾‹"""
    
    # 1. åŠ è½½æ‰€æœ‰æˆåŠŸæ¡ˆä¾‹
    cases = self._load_success_cases()
    
    # 2. æŒ‰Skillè¿‡æ»¤
    if skill_name:
        cases = [c for c in cases if c.get('skill') == skill_name]
    
    # 3. æŒ‰ç›¸ä¼¼åº¦æ’åºï¼ˆå¦‚æœæä¾›äº†queryï¼‰
    if query and cases:
        cases = self._rank_by_similarity(cases, query)
    
    # 4. è¿”å›å‰Nä¸ª
    return cases[:limit]


def _rank_by_similarity(self, cases: List[Dict], query: str) -> List[Dict]:
    """æŒ‰ä¸queryçš„ç›¸ä¼¼åº¦æ’åº"""
    
    def similarity(case):
        # ç®€å•çš„è¯é‡å ç›¸ä¼¼åº¦
        case_words = set(case.get('user_input', '').lower().split())
        query_words = set(query.lower().split())
        if not case_words:
            return 0
        overlap = len(case_words & query_words)
        return overlap / len(case_words)
    
    return sorted(cases, key=similarity, reverse=True)


def _load_success_cases(self) -> List[Dict]:
    """åŠ è½½æˆåŠŸæ¡ˆä¾‹"""
    cases = []
    
    # ä»æ¡ˆä¾‹æ–‡ä»¶åŠ è½½
    case_file = self.data_dir / "cases.jsonl"
    if case_file.exists():
        with open(case_file, 'r', encoding='utf-8') as f:
            for line in f:
                try:
                    case = json.loads(line)
                    if case.get('success', False):
                        cases.append(case)
                except:
                    continue
    
    return cases
```

### éªŒæ”¶æ ‡å‡†
- [ ] Planning Promptä¸­åŒ…å«æœ€å¤š3ä¸ªç›¸å…³çš„æˆåŠŸæ¡ˆä¾‹
- [ ] æ¡ˆä¾‹æŒ‰ç›¸ä¼¼åº¦æ’åºï¼Œæœ€ç›¸å…³çš„åœ¨å‰
- [ ] æ²¡æœ‰ç›¸å…³æ¡ˆä¾‹æ—¶ï¼Œæ­£å¸¸æ‰§è¡Œï¼ˆä¸æŠ¥é”™ï¼‰
- [ ] å¯ä»¥é€šè¿‡æ—¥å¿—çœ‹åˆ°ä½¿ç”¨äº†å“ªäº›ç¤ºä¾‹

---

## ä»»åŠ¡ä¸‰ï¼šRAGå‚è€ƒæ¥æºå»é‡ä¼˜åŒ–

### ç›®æ ‡
- RAGå›ç­”ä¸­çš„"å‚è€ƒæ–‡æ¡£æ¥æº"éœ€è¦å»é‡
- ä¼˜åŒ–æ¥æºå±•ç¤ºæ ¼å¼ï¼Œæ›´ç®€æ´ä¸“ä¸š

### å½“å‰é—®é¢˜
å¦‚å›¾æ‰€ç¤ºï¼Œå‚è€ƒæ¥æºåˆ—è¡¨ä¸­æœ‰é‡å¤ï¼š
```
1.ã€Šä¸­å›½ç§»åŠ¨æºç¯å¢ƒç®¡ç†å¹´æŠ¥ã€‹ï¼ˆ2021å¹´ï¼‰
2.ã€Šä¸­å›½ç§»åŠ¨æºç¯å¢ƒç®¡ç†å¹´æŠ¥ã€‹ï¼ˆ2021å¹´ï¼‰  â† é‡å¤
3.ã€Šæ±½æ²¹è½¦æ±¡æŸ“ç‰©æ’æ”¾é™å€¼åŠæµ‹é‡æ–¹æ³•...ã€‹
...
```

### å®ç°è¦æ±‚

#### 1. ä¿®æ”¹RAGç»“æœåå¤„ç†é€»è¾‘

æ‰¾åˆ°RAGç›¸å…³çš„ä»£ç ï¼ˆå¯èƒ½åœ¨ `skills/knowledge/skill.py` æˆ– `skills/knowledge/retriever.py`ï¼‰ï¼Œæ·»åŠ å»é‡é€»è¾‘ï¼š

```python
def deduplicate_sources(sources: List[Dict]) -> List[Dict]:
    """å¯¹å‚è€ƒæ¥æºå»é‡"""
    
    seen = set()
    unique_sources = []
    
    for source in sources:
        # ç”Ÿæˆå”¯ä¸€æ ‡è¯†ï¼ˆåŸºäºæ–‡æ¡£åç§°ï¼‰
        doc_name = source.get('source', source.get('doc_name', ''))
        
        # æ ‡å‡†åŒ–æ–‡æ¡£åç§°ï¼ˆå»é™¤å¤šä½™ç©ºæ ¼ã€ç»Ÿä¸€æ ¼å¼ï¼‰
        normalized_name = normalize_doc_name(doc_name)
        
        if normalized_name and normalized_name not in seen:
            seen.add(normalized_name)
            unique_sources.append(source)
    
    return unique_sources


def normalize_doc_name(name: str) -> str:
    """æ ‡å‡†åŒ–æ–‡æ¡£åç§°"""
    if not name:
        return ""
    
    # å»é™¤å¤šä½™ç©ºæ ¼
    name = ' '.join(name.split())
    
    # ç»Ÿä¸€ä¹¦åå·
    name = name.replace('ã€Š', 'ã€Š').replace('ã€‹', 'ã€‹')
    
    return name
```

#### 2. ä¼˜åŒ–æ¥æºå±•ç¤ºæ ¼å¼

ä¿®æ”¹ç”Ÿæˆå›ç­”æ—¶çš„æ¥æºå±•ç¤ºé€»è¾‘ï¼š

```python
def format_sources_section(sources: List[Dict]) -> str:
    """æ ¼å¼åŒ–å‚è€ƒæ¥æºéƒ¨åˆ†"""
    
    if not sources:
        return ""
    
    # å»é‡
    unique_sources = deduplicate_sources(sources)
    
    # å¦‚æœåªæœ‰1-2ä¸ªæ¥æºï¼Œç”¨æ›´ç®€æ´çš„æ ¼å¼
    if len(unique_sources) <= 2:
        source_names = [s.get('source', 'æœªçŸ¥æ¥æº') for s in unique_sources]
        return f"\n\n> ğŸ“š å‚è€ƒæ¥æºï¼š{'ã€'.join(source_names)}"
    
    # å¤šä¸ªæ¥æºæ—¶ï¼Œä½¿ç”¨åˆ—è¡¨ä½†æ›´ç´§å‡‘
    lines = ["\n\n**å‚è€ƒæ–‡æ¡£æ¥æºï¼š**"]
    for i, source in enumerate(unique_sources, 1):
        doc_name = source.get('source', 'æœªçŸ¥æ¥æº')
        # å¦‚æœæœ‰é¡µç æˆ–ç« èŠ‚ä¿¡æ¯ï¼Œå¯ä»¥é™„åŠ 
        page_info = source.get('page', '')
        if page_info:
            lines.append(f"{i}. {doc_name}ï¼ˆ{page_info}ï¼‰")
        else:
            lines.append(f"{i}. {doc_name}")
    
    return '\n'.join(lines)
```

#### 3. åœ¨Skillæ‰§è¡Œç»“æœä¸­åº”ç”¨

ç¡®ä¿åœ¨Knowledge Skillè¿”å›ç»“æœæ—¶è°ƒç”¨è¿™ä¸ªæ ¼å¼åŒ–å‡½æ•°ï¼š

```python
# skills/knowledge/skill.py

class KnowledgeSkill(Skill):
    def execute(self, **kwargs) -> SkillResult:
        # ... æ£€ç´¢é€»è¾‘ ...
        
        # è·å–æ£€ç´¢ç»“æœ
        results = self.retriever.search(query, top_k=kwargs.get('top_k', 5))
        
        # æå–æ¥æºå¹¶å»é‡
        sources = [r.get('metadata', {}) for r in results]
        unique_sources = deduplicate_sources(sources)
        
        # ç”Ÿæˆå›ç­”
        answer = self._generate_answer(query, results)
        
        # æ·»åŠ æ ¼å¼åŒ–çš„æ¥æºéƒ¨åˆ†
        sources_section = format_sources_section(unique_sources)
        full_answer = answer + sources_section
        
        return SkillResult(
            success=True,
            data={
                'answer': full_answer,
                'sources': unique_sources,  # å­˜å‚¨å»é‡åçš„æ¥æº
                'raw_results': results
            }
        )
```

### éªŒæ”¶æ ‡å‡†
- [ ] å‚è€ƒæ¥æºåˆ—è¡¨ä¸­æ— é‡å¤é¡¹
- [ ] æ¥æºåç§°æ ¼å¼ç»Ÿä¸€
- [ ] 1-2ä¸ªæ¥æºæ—¶ä½¿ç”¨ç®€æ´çš„è¡Œå†…æ ¼å¼
- [ ] 3ä¸ªä»¥ä¸Šæ¥æºæ—¶ä½¿ç”¨ç¼–å·åˆ—è¡¨
- [ ] æ¥æºä¸ºç©ºæ—¶ä¸æ˜¾ç¤ºå‚è€ƒæ¥æºéƒ¨åˆ†

---

## ä»»åŠ¡å››ï¼šä¼šè¯å†å²æŒä¹…åŒ–å­˜å‚¨

### ç›®æ ‡
æœåŠ¡é‡å¯åï¼Œç”¨æˆ·ä¹‹å‰çš„å¯¹è¯è®°å½•ä»ç„¶ä¿ç•™ï¼Œå¯ä»¥ç»§ç»­ä¹‹å‰çš„ä¼šè¯ã€‚

### å½“å‰é—®é¢˜
- ä¼šè¯æ•°æ®åªå­˜åœ¨å†…å­˜ä¸­
- æœåŠ¡é‡å¯ï¼ˆ`.\scripts\restart_server.ps1`ï¼‰åæ‰€æœ‰ä¼šè¯ä¸¢å¤±
- ç”¨æˆ·éœ€è¦é‡æ–°å¼€å§‹å¯¹è¯

### å®ç°è¦æ±‚

#### 1. ä¿®æ”¹ `api/session.py`ï¼Œæ·»åŠ æŒä¹…åŒ–

```python
import json
import os
from pathlib import Path
from datetime import datetime, timedelta
from typing import Dict, Optional
import threading

class SessionManager:
    def __init__(self, storage_dir: str = "data/sessions"):
        self.storage_dir = Path(storage_dir)
        self.storage_dir.mkdir(parents=True, exist_ok=True)
        
        self._sessions: Dict[str, Session] = {}
        self._lock = threading.Lock()
        
        # å¯åŠ¨æ—¶åŠ è½½å·²æœ‰ä¼šè¯
        self._load_all_sessions()
    
    def _load_all_sessions(self):
        """å¯åŠ¨æ—¶åŠ è½½æ‰€æœ‰æŒä¹…åŒ–çš„ä¼šè¯"""
        for session_file in self.storage_dir.glob("*.json"):
            try:
                session_id = session_file.stem
                session = self._load_session_from_file(session_id)
                if session:
                    self._sessions[session_id] = session
            except Exception as e:
                print(f"åŠ è½½ä¼šè¯ {session_file} å¤±è´¥: {e}")
    
    def _load_session_from_file(self, session_id: str) -> Optional[Session]:
        """ä»æ–‡ä»¶åŠ è½½å•ä¸ªä¼šè¯"""
        file_path = self.storage_dir / f"{session_id}.json"
        if not file_path.exists():
            return None
        
        with open(file_path, 'r', encoding='utf-8') as f:
            data = json.load(f)
        
        # æ£€æŸ¥æ˜¯å¦è¿‡æœŸï¼ˆä¾‹å¦‚24å°æ—¶ï¼‰
        last_active = datetime.fromisoformat(data.get('last_active', ''))
        if datetime.now() - last_active > timedelta(hours=24):
            # ä¼šè¯è¿‡æœŸï¼Œåˆ é™¤æ–‡ä»¶
            file_path.unlink()
            return None
        
        # é‡å»ºSessionå¯¹è±¡
        session = Session(session_id=session_id)
        session.restore_from_data(data)
        return session
    
    def _save_session_to_file(self, session: Session):
        """å°†ä¼šè¯ä¿å­˜åˆ°æ–‡ä»¶"""
        file_path = self.storage_dir / f"{session.session_id}.json"
        data = session.to_serializable_dict()
        data['last_active'] = datetime.now().isoformat()
        
        with open(file_path, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
    
    def get_or_create(self, session_id: str = None) -> Session:
        """è·å–æˆ–åˆ›å»ºä¼šè¯"""
        with self._lock:
            if session_id and session_id in self._sessions:
                session = self._sessions[session_id]
                session.last_active = datetime.now()
                self._save_session_to_file(session)  # æ›´æ–°æ´»è·ƒæ—¶é—´
                return session
            
            # åˆ›å»ºæ–°ä¼šè¯
            new_session = Session()
            self._sessions[new_session.session_id] = new_session
            self._save_session_to_file(new_session)
            return new_session
    
    def save(self, session: Session):
        """ä¿å­˜ä¼šè¯ï¼ˆæ¯æ¬¡å¯¹è¯åè°ƒç”¨ï¼‰"""
        with self._lock:
            self._save_session_to_file(session)
    
    def delete(self, session_id: str):
        """åˆ é™¤ä¼šè¯"""
        with self._lock:
            if session_id in self._sessions:
                del self._sessions[session_id]
            
            file_path = self.storage_dir / f"{session_id}.json"
            if file_path.exists():
                file_path.unlink()
    
    def list_sessions(self) -> list:
        """åˆ—å‡ºæ‰€æœ‰ä¼šè¯ï¼ˆç”¨äºå‰ç«¯æ˜¾ç¤ºï¼‰"""
        sessions = []
        for session_id, session in self._sessions.items():
            sessions.append({
                'session_id': session_id,
                'title': session.get_title(),
                'last_active': session.last_active.isoformat() if session.last_active else None,
                'turn_count': len(session.context.turns) if session.context else 0
            })
        
        # æŒ‰æœ€åæ´»è·ƒæ—¶é—´æ’åº
        sessions.sort(key=lambda x: x['last_active'] or '', reverse=True)
        return sessions
```

#### 2. ä¿®æ”¹ `Session` ç±»ï¼Œæ·»åŠ åºåˆ—åŒ–æ–¹æ³•

```python
class Session:
    def __init__(self, session_id: str = None):
        self.session_id = session_id or str(uuid.uuid4())
        self.agent = EmissionAgent()
        self.context = ConversationContext()
        self.created_at = datetime.now()
        self.last_active = datetime.now()
    
    def to_serializable_dict(self) -> dict:
        """è½¬æ¢ä¸ºå¯åºåˆ—åŒ–çš„å­—å…¸"""
        return {
            'session_id': self.session_id,
            'created_at': self.created_at.isoformat(),
            'last_active': self.last_active.isoformat(),
            'context': self.context.to_dict() if self.context else {},
            # AgentçŠ¶æ€ï¼ˆå¦‚æœæœ‰éœ€è¦ä¿å­˜çš„ï¼‰
            'agent_state': self.agent.get_state() if hasattr(self.agent, 'get_state') else {}
        }
    
    def restore_from_data(self, data: dict):
        """ä»æ•°æ®æ¢å¤ä¼šè¯çŠ¶æ€"""
        self.created_at = datetime.fromisoformat(data.get('created_at', datetime.now().isoformat()))
        self.last_active = datetime.fromisoformat(data.get('last_active', datetime.now().isoformat()))
        
        # æ¢å¤Context
        if data.get('context'):
            self.context = ConversationContext.from_dict(data['context'])
            # å°†contextä¼ é€’ç»™agent
            self.agent.set_context(self.context)
    
    def get_title(self) -> str:
        """è·å–ä¼šè¯æ ‡é¢˜ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰"""
        if self.context and self.context.turns:
            # ä½¿ç”¨ç¬¬ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ä½œä¸ºæ ‡é¢˜
            first_user_msg = self.context.turns[0].user_input
            return first_user_msg[:30] + ('...' if len(first_user_msg) > 30 else '')
        return f"ä¼šè¯ {self.session_id[:8]}"
```

#### 3. ä¿®æ”¹ `ConversationContext`ï¼Œæ·»åŠ åºåˆ—åŒ–æ–¹æ³•

åœ¨ `agent/context.py` ä¸­æ·»åŠ ï¼š

```python
class ConversationContext:
    # ... ç°æœ‰ä»£ç  ...
    
    def to_dict(self) -> dict:
        """è½¬æ¢ä¸ºå­—å…¸"""
        return {
            'turns': [turn.to_dict() for turn in self.turns],
            'metadata': self.metadata,
            'param_snapshots': self.param_snapshots
        }
    
    @classmethod
    def from_dict(cls, data: dict) -> 'ConversationContext':
        """ä»å­—å…¸æ¢å¤"""
        context = cls()
        context.turns = [Turn.from_dict(t) for t in data.get('turns', [])]
        context.metadata = data.get('metadata', {})
        context.param_snapshots = data.get('param_snapshots', {})
        return context


class Turn:
    # ... ç°æœ‰ä»£ç  ...
    
    def to_dict(self) -> dict:
        """è½¬æ¢ä¸ºå­—å…¸"""
        return {
            'user_input': self.user_input,
            'assistant_response': self.assistant_response,
            'skill_executions': [
                {
                    'skill': se.skill,
                    'params': se.params,
                    'success': se.success,
                    'result_summary': se.result_summary
                }
                for se in self.skill_executions
            ],
            'timestamp': self.timestamp.isoformat() if self.timestamp else None
        }
    
    @classmethod
    def from_dict(cls, data: dict) -> 'Turn':
        """ä»å­—å…¸æ¢å¤"""
        turn = cls()
        turn.user_input = data.get('user_input', '')
        turn.assistant_response = data.get('assistant_response', '')
        turn.skill_executions = [
            SkillExecution(**se) for se in data.get('skill_executions', [])
        ]
        turn.timestamp = datetime.fromisoformat(data['timestamp']) if data.get('timestamp') else None
        return turn
```

#### 4. åœ¨APIè·¯ç”±ä¸­ä¿å­˜ä¼šè¯

ç¡®ä¿æ¯æ¬¡å¯¹è¯åä¿å­˜ä¼šè¯ï¼š

```python
# api/routes.py

@router.post("/chat")
async def chat(request: ChatRequest):
    session = session_manager.get_or_create(request.session_id)
    
    try:
        result = session.agent.chat(request.message)
        
        # ä¿å­˜ä¼šè¯ ã€æ–°å¢ã€‘
        session_manager.save(session)
        
        return ChatResponse(...)
    except Exception as e:
        raise HTTPException(...)
```

#### 5. æ·»åŠ ä¼šè¯åˆ—è¡¨APIï¼ˆå¯é€‰ï¼Œç”¨äºå‰ç«¯æ˜¾ç¤ºå†å²ä¼šè¯ï¼‰

```python
@router.get("/sessions")
async def list_sessions():
    """è·å–æ‰€æœ‰ä¼šè¯åˆ—è¡¨"""
    return {"sessions": session_manager.list_sessions()}

@router.delete("/sessions/{session_id}")
async def delete_session(session_id: str):
    """åˆ é™¤æŒ‡å®šä¼šè¯"""
    session_manager.delete(session_id)
    return {"success": True}
```

### éªŒæ”¶æ ‡å‡†
- [ ] æœåŠ¡é‡å¯åï¼Œä¹‹å‰çš„ä¼šè¯ä»ç„¶å­˜åœ¨
- [ ] å¯ä»¥ç»§ç»­ä¹‹å‰çš„å¯¹è¯ï¼Œä¸Šä¸‹æ–‡ä¿æŒ
- [ ] ä¼šè¯æ–‡ä»¶å­˜å‚¨åœ¨ `data/sessions/` ç›®å½•
- [ ] è¶…è¿‡24å°æ—¶çš„ä¼šè¯è‡ªåŠ¨æ¸…ç†
- [ ] åˆ é™¤ä¼šè¯æ—¶åŒæ—¶åˆ é™¤æ–‡ä»¶
- [ ] ï¼ˆå¯é€‰ï¼‰å‰ç«¯å¯ä»¥æ˜¾ç¤ºå†å²ä¼šè¯åˆ—è¡¨

---

## æ‰§è¡Œé¡ºåºå»ºè®®

1. **ä»»åŠ¡å››ï¼ˆä¼šè¯æŒä¹…åŒ–ï¼‰** - æœ€åŸºç¡€ï¼Œå…¶ä»–åŠŸèƒ½éƒ½ä¾èµ–å®ƒ
2. **ä»»åŠ¡ä¸‰ï¼ˆRAGå»é‡ï¼‰** - æœ€ç®€å•ï¼Œå¿«é€Ÿè§æ•ˆ
3. **ä»»åŠ¡äºŒï¼ˆFew-shotï¼‰** - æå‡å‡†ç¡®ç‡
4. **ä»»åŠ¡ä¸€ï¼ˆæµå¼è¾“å‡ºï¼‰** - æœ€å¤æ‚ï¼Œä½†ç”¨æˆ·ä½“éªŒæå‡æœ€å¤§

## æµ‹è¯•éªŒè¯

å®Œæˆåï¼Œè¯·è¿›è¡Œä»¥ä¸‹æµ‹è¯•ï¼š

1. **æµå¼è¾“å‡ºæµ‹è¯•**
   - å‘é€æ¶ˆæ¯ï¼Œè§‚å¯Ÿæ˜¯å¦ç«‹å³æœ‰å“åº”
   - æ£€æŸ¥æ–‡æœ¬æ˜¯å¦é€æ­¥æ˜¾ç¤º
   
2. **Few-shotæµ‹è¯•**
   - å…ˆæ‰§è¡Œå‡ æ¬¡æˆåŠŸçš„æŸ¥è¯¢ï¼Œè®©Learneræ”¶é›†æ¡ˆä¾‹
   - å†æ‰§è¡Œç±»ä¼¼æŸ¥è¯¢ï¼ŒæŸ¥çœ‹æ—¥å¿—ç¡®è®¤ä½¿ç”¨äº†Few-shotç¤ºä¾‹
   
3. **RAGå»é‡æµ‹è¯•**
   - æ‰§è¡ŒçŸ¥è¯†æ£€ç´¢æŸ¥è¯¢
   - æ£€æŸ¥å‚è€ƒæ¥æºæ˜¯å¦æœ‰é‡å¤
   
4. **æŒä¹…åŒ–æµ‹è¯•**
   - è¿›è¡Œå‡ è½®å¯¹è¯
   - æ‰§è¡Œ `.\scripts\restart_server.ps1`
   - åˆ·æ–°é¡µé¢ï¼Œæ£€æŸ¥å¯¹è¯è®°å½•æ˜¯å¦ä¿ç•™

---

## æ³¨æ„äº‹é¡¹

1. ä¿®æ”¹å‰è¯·å…ˆå¤‡ä»½ç›¸å…³æ–‡ä»¶
2. æ¯å®Œæˆä¸€ä¸ªä»»åŠ¡å°±æµ‹è¯•ï¼Œä¸è¦ä¸€æ¬¡æ€§æ”¹å®Œæ‰€æœ‰
3. å¦‚æœé‡åˆ°ä¾èµ–ç¼ºå¤±ï¼Œæ£€æŸ¥ `requirements.txt`
4. æ—¥å¿—ä¸­æ·»åŠ é€‚å½“çš„è°ƒè¯•ä¿¡æ¯ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜
