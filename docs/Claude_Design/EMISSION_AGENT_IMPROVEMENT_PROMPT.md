# Emission Agent åŠŸèƒ½æ”¹è¿›ä»»åŠ¡

## é¡¹ç›®ä½ç½®
`D:\Agent_MCP\emission_agent`

## ä»»åŠ¡æ¦‚è¿°

éœ€è¦å®Œæˆä¸‰ä¸ªæ”¹è¿›ï¼š
1. **ä»»åŠ¡ç±»å‹åˆ¤æ–­é”™è¯¯**ï¼šå®è§‚æ’æ”¾æ–‡ä»¶è¢«å½“ä½œå¾®è§‚æ’æ”¾å¤„ç†ï¼Œè¿½é—®å†…å®¹å®Œå…¨é”™è¯¯
2. **è¿½é—®è´¨é‡æå‡**ï¼šPlanningé˜¶æ®µè¦å…ˆåˆ†æä¸Šä¼ æ–‡ä»¶ï¼Œç”Ÿæˆæœ‰é’ˆå¯¹æ€§çš„è¿½é—®
3. **æ–°å¢ç»“æœä¸‹è½½åŠŸèƒ½**ï¼šè®¡ç®—å®Œæˆåï¼Œåœ¨åŸæ–‡ä»¶åŸºç¡€ä¸Šè¿½åŠ æ’æ”¾åˆ—ï¼Œæä¾›ä¸‹è½½é“¾æ¥

---

## ä»»åŠ¡0ï¼šä¿®å¤ä»»åŠ¡ç±»å‹åˆ¤æ–­é”™è¯¯ [æœ€é«˜ä¼˜å…ˆçº§]

### é—®é¢˜ç°çŠ¶

ç”¨æˆ·ä¸Šä¼ äº†ä¸€ä¸ª**å®è§‚æ’æ”¾æ–‡ä»¶**ï¼ˆè·¯æ®µæ•°æ®ï¼ŒåŒ…å« `link_id`, `length_km`, `flow`, `speed`, `Car%`, `Bus%` ç­‰åˆ—ï¼‰ï¼Œä½†ç³»ç»Ÿçš„è¿½é—®å†…å®¹å®Œå…¨æ˜¯**å¾®è§‚æ’æ”¾**çš„é€»è¾‘ï¼š

```
"åœ¨æœºåŠ¨è½¦æ’æ”¾è®¡ç®—ä¸­ï¼Œå¿…é¡»æŒ‡å®šè½¦è¾†ç±»å‹ï¼Œæ˜¯å› ä¸ºä¸åŒç±»å‹çš„è½¦è¾†ï¼ˆå¦‚å°æ±½è½¦ã€å…¬äº¤è½¦ã€é‡å‹è´§è½¦ç­‰ï¼‰å…·æœ‰æ˜¾è‘—ä¸åŒçš„ï¼š
- æ’æ”¾å› å­ï¼ˆå•ä½é‡Œç¨‹æˆ–å•ä½æ—¶é—´çš„æ±¡æŸ“ç‰©æ’æ”¾é‡ï¼‰
- å¹³å‡è¡Œé©¶é€Ÿåº¦ä¸è¿è¡Œå·¥å†µ
- ç‡ƒæ²¹ç±»å‹ä¸å‘åŠ¨æœºæŠ€æœ¯"
```

**è¿™å®Œå…¨æ˜¯é”™è¯¯çš„ï¼** å› ä¸ºï¼š
- å®è§‚æ’æ”¾æ–‡ä»¶é€šå¸¸**å·²ç»åŒ…å«è½¦å‹æ¯”ä¾‹åˆ—**ï¼ˆå¦‚ `Car%`, `Bus%`, `Truck%`ï¼‰
- ä¸éœ€è¦ç”¨æˆ·å•ç‹¬æŒ‡å®šä¸€ä¸ªè½¦å‹
- è¿½é—®åº”è¯¥æ˜¯ï¼š"æ‚¨çš„æ–‡ä»¶å·²åŒ…å«è½¦å‹æ¯”ä¾‹ï¼Œæ˜¯å¦ä½¿ç”¨è¿™äº›æ¯”ä¾‹è®¡ç®—ï¼Ÿ"

### æ ¹æœ¬åŸå› 

1. **Planning é˜¶æ®µæ²¡æœ‰å…ˆåˆ†ææ–‡ä»¶å†…å®¹**æ¥åˆ¤æ–­ä»»åŠ¡ç±»å‹
2. **è¿½é—®æ¨¡æ¿æ˜¯é€šç”¨çš„**ï¼Œæ²¡æœ‰åŒºåˆ†å¾®è§‚/å®è§‚
3. **æ²¡æœ‰è¯†åˆ«æ–‡ä»¶ä¸­çš„è½¦å‹æ¯”ä¾‹åˆ—**

### å¾®è§‚ vs å®è§‚åˆ¤æ–­è§„åˆ™

| ç‰¹å¾ | å¾®è§‚æ’æ”¾ | å®è§‚æ’æ”¾ |
|------|----------|----------|
| **æ•°æ®ç²’åº¦** | é€ç§’è½¨è¿¹ | è·¯æ®µæ±‡æ€» |
| **å…¸å‹åˆ—å** | time, speed, acceleration | link_id, length, flow, speed |
| **è½¦å‹ä¿¡æ¯** | éœ€è¦ç”¨æˆ·æŒ‡å®šå•ä¸€è½¦å‹ | é€šå¸¸åŒ…å«è½¦å‹æ¯”ä¾‹åˆ—ï¼ˆ%ï¼‰ |
| **æ—¶é—´åˆ—** | æœ‰ï¼ˆç§’çº§ï¼‰ | æ— æˆ–å°æ—¶çº§ |
| **åŠ é€Ÿåº¦åˆ—** | é€šå¸¸æœ‰ | é€šå¸¸æ—  |
| **è·¯æ®µIDåˆ—** | é€šå¸¸æ—  | å¿…é¡»æœ‰ |

### ä¿®æ”¹æ–¹æ¡ˆ

**æ–‡ä»¶**: `agent/prompts/system.py`

åœ¨ Planning é˜¶æ®µæ·»åŠ ä»»åŠ¡ç±»å‹åˆ¤æ–­è§„åˆ™ï¼š

```python
TASK_TYPE_DETECTION_RULES = """
## ä»»åŠ¡ç±»å‹åˆ¤æ–­è§„åˆ™ï¼ˆå¿…é¡»åœ¨è¿½é—®å‰æ‰§è¡Œï¼‰

å½“ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶è¯·æ±‚è®¡ç®—æ’æ”¾æ—¶ï¼Œå¿…é¡»å…ˆåˆ¤æ–­ä»»åŠ¡ç±»å‹ï¼š

### åˆ¤æ–­æ–¹æ³•

æ£€æŸ¥æ–‡ä»¶åˆ—åï¼ŒæŒ‰ä»¥ä¸‹è§„åˆ™åˆ¤æ–­ï¼š

**å¾®è§‚æ’æ”¾ç‰¹å¾**ï¼ˆéœ€è¦ 3 ä¸ªä»¥ä¸ŠåŒ¹é…ï¼‰ï¼š
- æœ‰æ—¶é—´åˆ—ï¼štime, t, æ—¶é—´, timestamp, time_sec
- æœ‰é€Ÿåº¦åˆ—ï¼šspeed, velocity, é€Ÿåº¦, speed_kph
- æœ‰åŠ é€Ÿåº¦åˆ—ï¼šacceleration, acc, åŠ é€Ÿåº¦
- æ•°æ®é‡å¤§ï¼ˆé€šå¸¸ >100 è¡Œï¼Œæ¯ç§’ä¸€æ¡ï¼‰
- æ— è·¯æ®µIDåˆ—

**å®è§‚æ’æ”¾ç‰¹å¾**ï¼ˆéœ€è¦ 3 ä¸ªä»¥ä¸ŠåŒ¹é…ï¼‰ï¼š
- æœ‰è·¯æ®µIDåˆ—ï¼šlink_id, segment_id, road_id, è·¯æ®µ
- æœ‰é•¿åº¦åˆ—ï¼šlength, len, é•¿åº¦, distance
- æœ‰æµé‡åˆ—ï¼šflow, volume, traffic, æµé‡
- æœ‰è½¦å‹æ¯”ä¾‹åˆ—ï¼šåŒ…å« % æˆ– pct çš„åˆ—åï¼ˆå¦‚ Car%, Bus%, Truck%ï¼‰
- æ•°æ®é‡é€‚ä¸­ï¼ˆé€šå¸¸ 10-1000 è¡Œï¼Œæ¯è¡Œä¸€ä¸ªè·¯æ®µï¼‰

### è¿½é—®å·®å¼‚

**å¾®è§‚æ’æ”¾è¿½é—®é‡ç‚¹**ï¼š
- è½¦è¾†ç±»å‹ï¼ˆå¿…é¡»æŒ‡å®šå•ä¸€è½¦å‹ï¼‰
- æ±¡æŸ“ç‰©ç±»å‹
- å¦‚æœç¼ºå°‘åŠ é€Ÿåº¦/å¡åº¦ï¼Œè¯¢é—®æ˜¯å¦ä½¿ç”¨é»˜è®¤å€¼

**å®è§‚æ’æ”¾è¿½é—®é‡ç‚¹**ï¼š
- å¦‚æœæ–‡ä»¶å·²æœ‰è½¦å‹æ¯”ä¾‹åˆ—ï¼Œä¸éœ€è¦è¿½é—®è½¦å‹ï¼
- å¦‚æœæ–‡ä»¶æ²¡æœ‰è½¦å‹æ¯”ä¾‹åˆ—ï¼Œè¯¢é—®æ˜¯ä½¿ç”¨é»˜è®¤è½¦å‹æ¯”ä¾‹è¿˜æ˜¯æŒ‡å®š
- æµé‡å•ä½ç¡®è®¤ï¼ˆæ—¥æµé‡ vs å°æ—¶æµé‡ï¼‰
- æ±¡æŸ“ç‰©ç±»å‹

### é”™è¯¯ç¤ºä¾‹ï¼ˆä¸è¦è¿™æ ·åšï¼‰

âŒ å¯¹å®è§‚æ–‡ä»¶è¯´"è¯·æŒ‡å®šè½¦è¾†ç±»å‹ï¼ˆå¦‚å°æ±½è½¦ã€å…¬äº¤è½¦ï¼‰"
âŒ å¯¹åŒ…å«è½¦å‹æ¯”ä¾‹çš„æ–‡ä»¶è¿˜è¦æ±‚ç”¨æˆ·æŒ‡å®šè½¦å‹
âŒ ä¸åˆ†ææ–‡ä»¶å°±ç›´æ¥è¿½é—®
âŒ ç”¨å¾®è§‚æ’æ”¾çš„é€»è¾‘è§£é‡Šå®è§‚æ’æ”¾çš„éœ€æ±‚

### æ­£ç¡®ç¤ºä¾‹

âœ… å¾®è§‚æ–‡ä»¶ï¼ˆæ— è½¦å‹ä¿¡æ¯ï¼‰ï¼š
"æ‚¨çš„æ–‡ä»¶æ˜¯è½¨è¿¹æ•°æ®ï¼ŒåŒ…å«æ—¶é—´ã€é€Ÿåº¦ã€åŠ é€Ÿåº¦ã€‚è¯·é—®è¿™æ˜¯å“ªç§è½¦è¾†çš„è½¨è¿¹ï¼Ÿ
1. å°æ±½è½¦  2. å…¬äº¤è½¦  3. è½»å‹è´§è½¦  4. é‡å‹è´§è½¦"

âœ… å®è§‚æ–‡ä»¶ï¼ˆæœ‰è½¦å‹æ¯”ä¾‹ï¼‰ï¼š
"æ‚¨çš„æ–‡ä»¶æ˜¯è·¯æ®µæ•°æ®ï¼ŒåŒ…å« 35 æ¡è·¯æ®µï¼Œå·²è¯†åˆ«è½¦å‹æ¯”ä¾‹åˆ—ï¼ˆCar% 80%, Bus% 5%...ï¼‰ã€‚
å°†ä½¿ç”¨æ–‡ä»¶ä¸­çš„è½¦å‹æ¯”ä¾‹è®¡ç®—æ’æ”¾ã€‚è¯·é—®è¦è®¡ç®—å“ªäº›æ±¡æŸ“ç‰©ï¼Ÿ"

âœ… å®è§‚æ–‡ä»¶ï¼ˆæ— è½¦å‹æ¯”ä¾‹ï¼‰ï¼š
"æ‚¨çš„æ–‡ä»¶æ˜¯è·¯æ®µæ•°æ®ï¼Œä½†æœªåŒ…å«è½¦å‹æ¯”ä¾‹ä¿¡æ¯ã€‚è¯·é€‰æ‹©ï¼š
1. ä½¿ç”¨é»˜è®¤è½¦å‹æ¯”ä¾‹ï¼ˆå°æ±½è½¦ 70%, å…¬äº¤ 10%, è´§è½¦ 20%ï¼‰
2. æ‰‹åŠ¨æŒ‡å®šè½¦å‹æ¯”ä¾‹"
"""
```

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶

1. **`agent/prompts/system.py`**ï¼šæ·»åŠ ä¸Šè¿°ä»»åŠ¡ç±»å‹åˆ¤æ–­è§„åˆ™
2. **`agent/planner.py`**ï¼ˆå¦‚æœæœ‰ï¼‰ï¼šåœ¨ç”Ÿæˆè®¡åˆ’å‰å…ˆåˆ¤æ–­ä»»åŠ¡ç±»å‹
3. **`agent/core.py`**ï¼šç¡®ä¿æ–‡ä»¶åˆ†æåœ¨ Planning ä¹‹å‰æ‰§è¡Œ

---

## ä»»åŠ¡1ï¼šè¿½é—®è´¨é‡æå‡

### é—®é¢˜ç°çŠ¶

å½“å‰è¿½é—®è¿‡äºç®€å•å’Œæ³›æ³›ï¼š
```
"è¯·æŒ‡å®šè½¦è¾†ç±»å‹ï¼ˆå¦‚å°æ±½è½¦ã€å…¬äº¤è½¦ã€è´§è½¦ç­‰ï¼‰ï¼Œä»¥ä¾¿å‡†ç¡®è®¡ç®—æ’æ”¾ã€‚"
```

ç”¨æˆ·ä½“éªŒå·®ï¼š
- æ²¡æœ‰å‘Šè¯‰ç”¨æˆ·æ–‡ä»¶é‡Œå·²ç»æœ‰ä»€ä¹ˆ
- æ²¡æœ‰è¯´æ˜å…·ä½“ç¼ºå°‘ä»€ä¹ˆ
- æ²¡æœ‰ç»™å‡ºé€‰é¡¹è®©ç”¨æˆ·å¿«é€Ÿé€‰æ‹©

### æœŸæœ›çš„è¿½é—®æ•ˆæœ

**ç¤ºä¾‹1ï¼šæ–‡ä»¶å·²åŒ…å«è½¦å‹æ¯”ä¾‹æ—¶**
```
æˆ‘å·²åˆ†ææ‚¨ä¸Šä¼ çš„æ–‡ä»¶ `macro_05_highway_network.csv`ï¼š

ğŸ“Š **æ–‡ä»¶æ¦‚è§ˆ**ï¼šå…±35æ¡è·¯æ®µæ•°æ®

âœ… **å·²è¯†åˆ«çš„å­—æ®µ**ï¼š
- è·¯æ®µæ ‡è¯†: segment_id
- è·¯æ®µé•¿åº¦: length_km (å•ä½: km)
- äº¤é€šæµé‡: daily_traffic (âš ï¸ æ—¥æµé‡ï¼Œå°†è‡ªåŠ¨è½¬æ¢ä¸ºå°æ—¶æµé‡)
- å¹³å‡é€Ÿåº¦: avg_speed (å•ä½: km/h)
- è½¦å‹æ¯”ä¾‹: passenger_vehicles_pct, light_trucks_pct, heavy_trucks_pct, buses_pct

âœ… **æ–‡ä»¶å·²åŒ…å«å®Œæ•´çš„è½¦å‹æ¯”ä¾‹ä¿¡æ¯**ï¼Œæ— éœ€é¢å¤–æŒ‡å®šã€‚

è¯·é—®æ‚¨æƒ³è®¡ç®—å“ªäº›æ±¡æŸ“ç‰©ï¼Ÿ
1. CO2 + NOxï¼ˆæ¨èï¼Œæœ€å¸¸ç”¨ï¼‰
2. å…¨éƒ¨7ç§æ±¡æŸ“ç‰©ï¼ˆCO2, CO, NOx, PM2.5, PM10, THC, SO2ï¼‰
3. è‡ªå®šä¹‰é€‰æ‹©

æˆ–ç›´æ¥å›å¤"è®¡ç®—"ï¼Œæˆ‘å°†ä½¿ç”¨é»˜è®¤é…ç½®ï¼ˆCO2 + NOxï¼‰å¼€å§‹è®¡ç®—ã€‚
```

**ç¤ºä¾‹2ï¼šæ–‡ä»¶ç¼ºå°‘è½¦å‹ä¿¡æ¯æ—¶**
```
æˆ‘å·²åˆ†ææ‚¨ä¸Šä¼ çš„æ–‡ä»¶ `trajectory_data.xlsx`ï¼š

ğŸ“Š **æ–‡ä»¶æ¦‚è§ˆ**ï¼šå…±1200æ¡è½¨è¿¹æ•°æ®

âœ… **å·²è¯†åˆ«çš„å­—æ®µ**ï¼š
- æ—¶é—´: time (å•ä½: ç§’)
- é€Ÿåº¦: speed_kph (å•ä½: km/h)
- åŠ é€Ÿåº¦: acceleration (å•ä½: m/sÂ²)

âŒ **ç¼ºå°‘å¿…éœ€ä¿¡æ¯**ï¼š
- è½¦è¾†ç±»å‹ï¼ˆç”¨äºé€‰æ‹©å¯¹åº”çš„æ’æ”¾å› å­ï¼‰

è¯·æŒ‡å®šè½¦è¾†ç±»å‹ï¼š
1. å°æ±½è½¦ (Passenger Car) - ç§å®¶è½¦ã€å‡ºç§Ÿè½¦ã€ç½‘çº¦è½¦
2. å…¬äº¤è½¦ (Transit Bus) - åŸå¸‚å…¬äº¤
3. è½»å‹è´§è½¦ (Light Commercial Truck) - å¿«é€’è½¦ã€å°è´§è½¦
4. é‡å‹è´§è½¦ (Combination Long-haul Truck) - å¤§è´§è½¦ã€åŠæŒ‚è½¦
5. å…¶ä»–ï¼ˆè¯·è¯´æ˜ï¼‰

è¯·å›å¤æ•°å­—æˆ–è½¦å‹åç§°ã€‚
```

### ä¿®æ”¹æ–‡ä»¶

**ä¸»è¦ä¿®æ”¹**: `agent/prompts/system.py`

åœ¨ System Prompt ä¸­æ·»åŠ /ä¿®æ”¹è¿½é—®è§„åˆ™ï¼š

```python
FOLLOWUP_QUESTION_RULES = """
## è¿½é—®è§„åˆ™ï¼ˆé‡è¦ï¼ï¼‰

å½“éœ€è¦å‘ç”¨æˆ·è¿½é—®æ—¶ï¼Œå¿…é¡»éµå¾ªä»¥ä¸‹è§„åˆ™ï¼š

### 1. å…ˆåˆ†æåè¿½é—®
å¦‚æœç”¨æˆ·ä¸Šä¼ äº†æ–‡ä»¶ï¼Œè¿½é—®å‰å¿…é¡»å…ˆåˆ†ææ–‡ä»¶å†…å®¹å¹¶å‘ŠçŸ¥ç”¨æˆ·ï¼š
- æ–‡ä»¶åŸºæœ¬ä¿¡æ¯ï¼ˆè¡Œæ•°ã€åˆ—æ•°ï¼‰
- å·²è¯†åˆ«çš„å­—æ®µåŠå…¶å«ä¹‰
- å­—æ®µçš„å•ä½ï¼ˆå¦‚æœèƒ½æ¨æ–­ï¼‰
- ä»»ä½•éœ€è¦æ³¨æ„çš„é—®é¢˜ï¼ˆå¦‚æ—¥æµé‡éœ€è½¬æ¢ä¸ºå°æ—¶æµé‡ï¼‰

### 2. æ˜ç¡®è¯´æ˜ç¼ºå°‘ä»€ä¹ˆ
ä¸è¦æ³›æ³›åœ°è¯´"è¯·æä¾›æ›´å¤šä¿¡æ¯"ï¼Œè€Œè¦å…·ä½“è¯´æ˜ï¼š
- âœ… æ–‡ä»¶å·²æœ‰ä»€ä¹ˆ
- âŒ è¿˜ç¼ºå°‘ä»€ä¹ˆï¼ˆå…·ä½“å­—æ®µåï¼‰
- ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªä¿¡æ¯

### 3. æä¾›é€‰é¡¹è€Œéå¼€æ”¾é—®é¢˜
ç»™ç”¨æˆ·å…·ä½“çš„é€‰é¡¹ï¼Œè€Œä¸æ˜¯è®©ç”¨æˆ·è‡ªå·±æƒ³ï¼š
- è½¦å‹ï¼šåˆ—å‡ºå¸¸è§è½¦å‹è®©ç”¨æˆ·é€‰æ‹©ï¼ˆå¸¦ç¼–å·ï¼‰
- æ±¡æŸ“ç‰©ï¼šæä¾›æ¨èç»„åˆå’Œè‡ªå®šä¹‰é€‰é¡¹
- å­£èŠ‚/å¹´ä»½ï¼šæä¾›é»˜è®¤å€¼ï¼Œè®©ç”¨æˆ·ç¡®è®¤æˆ–ä¿®æ”¹

### 4. æä¾›é»˜è®¤é€‰é¡¹
æ€»æ˜¯æä¾›ä¸€ä¸ªé»˜è®¤/æ¨èé€‰é¡¹ï¼Œè®©ç”¨æˆ·å¯ä»¥å¿«é€Ÿç¡®è®¤ï¼š
- "æˆ–ç›´æ¥å›å¤'ç¡®è®¤'ï¼Œä½¿ç”¨é»˜è®¤é…ç½®å¼€å§‹è®¡ç®—"
- "æ¨èé€‰é¡¹å·²æ ‡æ³¨ â­"

### 5. è¿½é—®æ ¼å¼æ¨¡æ¿

```
æˆ‘å·²åˆ†ææ‚¨ä¸Šä¼ çš„æ–‡ä»¶ `{filename}`ï¼š

ğŸ“Š **æ–‡ä»¶æ¦‚è§ˆ**ï¼š{summary}

âœ… **å·²è¯†åˆ«çš„å­—æ®µ**ï¼š
{identified_fields}

âŒ **ç¼ºå°‘/éœ€è¦ç¡®è®¤çš„ä¿¡æ¯**ï¼š
{missing_info}

{options_or_question}

ğŸ’¡ æˆ–ç›´æ¥å›å¤"è®¡ç®—"/"ç¡®è®¤"ï¼Œä½¿ç”¨æ¨èé…ç½®ã€‚
```

### 6. æ™ºèƒ½åˆ—åæ˜ å°„ç»“æœè¦ä½“ç°
å¦‚æœè¿›è¡Œäº†åˆ—åæ˜ å°„ï¼Œè¦åœ¨è¿½é—®ä¸­è¯´æ˜ï¼š
- åŸå§‹åˆ—å â†’ æ ‡å‡†åˆ—å
- æ˜ å°„çš„ç½®ä¿¡åº¦
- ä»»ä½•è­¦å‘Šä¿¡æ¯ï¼ˆå¦‚å•ä½è½¬æ¢ï¼‰
"""
```

### ä¿®æ”¹å»ºè®®

1. **ä¿®æ”¹ `agent/prompts/system.py`**ï¼šæ·»åŠ ä¸Šè¿°è¿½é—®è§„åˆ™

2. **ä¿®æ”¹ `agent/planner.py`**ï¼ˆå¦‚æœæœ‰ï¼‰ï¼š
   - åœ¨ç”Ÿæˆè¿½é—®å‰ï¼Œå…ˆè°ƒç”¨æ–‡ä»¶åˆ†æ
   - å°†æ–‡ä»¶åˆ†æç»“æœæ³¨å…¥åˆ°è¿½é—®å†…å®¹ä¸­

3. **ä¿®æ”¹ `skills/*/excel_handler.py`**ï¼š
   - æ·»åŠ  `analyze_file()` æ–¹æ³•ï¼Œè¿”å›æ–‡ä»¶æ¦‚è§ˆ
   - åœ¨ Planning é˜¶æ®µå°±å¯ä»¥è°ƒç”¨

---

## ä»»åŠ¡2ï¼šæ–°å¢ç»“æœä¸‹è½½åŠŸèƒ½

### åŠŸèƒ½éœ€æ±‚

è®¡ç®—å®Œæˆåï¼Œç”Ÿæˆä¸€ä¸ªå¢å¼ºç‰ˆçš„Excelæ–‡ä»¶ï¼š
- ä¿ç•™åŸæ–‡ä»¶æ‰€æœ‰åˆ—
- åœ¨åé¢è¿½åŠ æ’æ”¾è®¡ç®—ç»“æœåˆ—
- æä¾›ä¸‹è½½é“¾æ¥

### è¾“å‡ºæ–‡ä»¶æ ¼å¼

**å¾®è§‚æ’æ”¾è¾“å‡ºç¤ºä¾‹**ï¼š
| time_sec | speed_kph | acceleration_mps2 | grade_pct | **CO2_g** | **NOx_g** | **PM2.5_g** |
|----------|-----------|-------------------|-----------|-----------|-----------|-------------|
| 0 | 0 | 0.5 | 0 | 0.00 | 0.00 | 0.00 |
| 1 | 5.4 | 1.5 | 0 | 2.34 | 0.012 | 0.0003 |
| 2 | 12.1 | 1.2 | 0 | 3.56 | 0.018 | 0.0005 |

**å®è§‚æ’æ”¾è¾“å‡ºç¤ºä¾‹**ï¼š
| link_id | length_km | flow_vph | speed_kph | Car% | Bus% | **CO2_kg_h** | **NOx_kg_h** |
|---------|-----------|----------|-----------|------|------|--------------|--------------|
| L001 | 2.5 | 1500 | 60 | 80 | 5 | 1234.56 | 4.32 |
| L002 | 3.2 | 2000 | 45 | 75 | 10 | 2345.67 | 8.91 |

### å®ç°æ­¥éª¤

#### Step 1: ä¿®æ”¹ Skill è¿”å›ç»“æœ

**æ–‡ä»¶**: `skills/micro_emission/handlers.py` å’Œ `skills/macro_emission/handlers.py`

åœ¨è®¡ç®—å®Œæˆåï¼Œç”Ÿæˆå¢å¼ºç‰ˆExcelå¹¶è¿”å›æ–‡ä»¶è·¯å¾„ï¼š

```python
# åœ¨ calculate_micro_emission æˆ– calculate_macro_emission å‡½æ•°æœ«å°¾

def generate_result_excel(original_df: pd.DataFrame, emission_results: dict, output_dir: str) -> str:
    """
    ç”ŸæˆåŒ…å«æ’æ”¾ç»“æœçš„å¢å¼ºç‰ˆExcel
    
    Args:
        original_df: åŸå§‹æ•°æ®DataFrame
        emission_results: æ’æ”¾è®¡ç®—ç»“æœ {pollutant: [values]}
        output_dir: è¾“å‡ºç›®å½•
    
    Returns:
        ç”Ÿæˆçš„æ–‡ä»¶è·¯å¾„
    """
    import os
    from datetime import datetime
    
    # å¤åˆ¶åŸå§‹æ•°æ®
    result_df = original_df.copy()
    
    # æ·»åŠ æ’æ”¾åˆ—
    for pollutant, values in emission_results.items():
        # å¾®è§‚æ’æ”¾å•ä½: gï¼ˆå…‹ï¼‰
        # å®è§‚æ’æ”¾å•ä½: kg/hï¼ˆåƒå…‹/å°æ—¶ï¼‰
        col_name = f"{pollutant}_{'g' if is_micro else 'kg_h'}"
        result_df[col_name] = values
    
    # ç”Ÿæˆæ–‡ä»¶å
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    original_name = os.path.splitext(os.path.basename(original_file))[0]
    output_filename = f"{original_name}_emission_results_{timestamp}.xlsx"
    output_path = os.path.join(output_dir, output_filename)
    
    # ä¿å­˜Excel
    result_df.to_excel(output_path, index=False, engine='openpyxl')
    
    return output_path
```

#### Step 2: ä¿®æ”¹ Skill è¿”å›æ ¼å¼

**æ–‡ä»¶**: `skills/micro_emission/handlers.py`

```python
# åœ¨è¿”å›ç»“æœä¸­æ·»åŠ  download_file å­—æ®µ

return {
    "success": True,
    "summary": {
        "total_emission": total_emission,
        "by_pollutant": by_pollutant,
        # ... å…¶ä»–æ±‡æ€»ä¿¡æ¯
    },
    "chart_data": chart_data,
    "table_data": table_data,
    
    # æ–°å¢ï¼šä¸‹è½½æ–‡ä»¶ä¿¡æ¯
    "download_file": {
        "path": output_path,
        "filename": output_filename,
        "description": "åŒ…å«æ’æ”¾è®¡ç®—ç»“æœçš„å®Œæ•´æ•°æ®æ–‡ä»¶"
    }
}
```

#### Step 3: ä¿®æ”¹ API è·¯ç”±

**æ–‡ä»¶**: `api/routes.py`

æ·»åŠ æ–‡ä»¶ä¸‹è½½ç«¯ç‚¹ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰ï¼š

```python
from fastapi.responses import FileResponse
import os

@router.get("/api/download/{filename}")
async def download_file(filename: str):
    """ä¸‹è½½è®¡ç®—ç»“æœæ–‡ä»¶"""
    # å®‰å…¨æ£€æŸ¥ï¼šåªå…è®¸ä¸‹è½½ outputs ç›®å½•ä¸‹çš„æ–‡ä»¶
    output_dir = os.path.join(os.path.dirname(__file__), "..", "outputs")
    file_path = os.path.join(output_dir, filename)
    
    # é˜²æ­¢è·¯å¾„éå†æ”»å‡»
    if not os.path.abspath(file_path).startswith(os.path.abspath(output_dir)):
        raise HTTPException(status_code=403, detail="Access denied")
    
    if not os.path.exists(file_path):
        raise HTTPException(status_code=404, detail="File not found")
    
    return FileResponse(
        path=file_path,
        filename=filename,
        media_type="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    )
```

#### Step 4: ä¿®æ”¹å“åº”å¤„ç†

**æ–‡ä»¶**: `api/routes.py` ä¸­çš„ `chat_stream` å‡½æ•°

åœ¨è¿”å›ç»“æœæ—¶ï¼ŒåŒ…å«ä¸‹è½½é“¾æ¥ï¼š

```python
# åœ¨å¤„ç† skill æ‰§è¡Œç»“æœæ—¶

if result.get("download_file"):
    download_info = result["download_file"]
    # ç”Ÿæˆä¸‹è½½é“¾æ¥
    download_url = f"/api/download/{download_info['filename']}"
    
    # æ·»åŠ åˆ°å“åº”ä¸­
    response_data["download"] = {
        "url": download_url,
        "filename": download_info["filename"],
        "description": download_info["description"]
    }
```

#### Step 5: ä¿®æ”¹å‰ç«¯æ˜¾ç¤º

**æ–‡ä»¶**: `web/app.js`

åœ¨æ¶ˆæ¯æ¸²æŸ“ä¸­æ·»åŠ ä¸‹è½½æŒ‰é’®ï¼š

```javascript
// åœ¨ renderMessage æˆ–ç±»ä¼¼å‡½æ•°ä¸­

function renderDownloadButton(downloadInfo) {
    if (!downloadInfo) return '';
    
    return `
        <div class="download-section" style="margin-top: 12px; padding: 12px; background: #f0f9ff; border-radius: 8px; border: 1px solid #bae6fd;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#0284c7" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                <span style="color: #0284c7; font-weight: 500;">è®¡ç®—ç»“æœæ–‡ä»¶</span>
            </div>
            <p style="margin: 8px 0 12px 0; color: #64748b; font-size: 14px;">
                ${downloadInfo.description || 'åŒ…å«åŸå§‹æ•°æ®å’Œæ’æ”¾è®¡ç®—ç»“æœçš„å®Œæ•´æ–‡ä»¶'}
            </p>
            <a href="${downloadInfo.url}" 
               download="${downloadInfo.filename}"
               class="download-btn"
               style="display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; 
                      background: #0284c7; color: white; border-radius: 6px; 
                      text-decoration: none; font-size: 14px; font-weight: 500;
                      transition: background 0.2s;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                ä¸‹è½½ ${downloadInfo.filename}
            </a>
        </div>
    `;
}

// åœ¨æ¶ˆæ¯æ¸²æŸ“æ—¶è°ƒç”¨
if (message.download) {
    messageHTML += renderDownloadButton(message.download);
}
```

**æ·»åŠ  CSS æ ·å¼**ï¼ˆåœ¨ `web/styles.css` æˆ–å†…è”ï¼‰ï¼š

```css
.download-btn:hover {
    background: #0369a1 !important;
}

.download-section {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
```

---

## æ–‡ä»¶ä¿®æ”¹æ¸…å•

| ä¼˜å…ˆçº§ | æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|--------|------|----------|
| **P0** | `agent/prompts/system.py` | æ·»åŠ ä»»åŠ¡ç±»å‹åˆ¤æ–­è§„åˆ™ï¼ˆå¾®è§‚vså®è§‚ï¼‰ï¼Œä¿®å¤è¿½é—®é€»è¾‘ |
| **P0** | `agent/planner.py` | åœ¨ç”Ÿæˆè®¡åˆ’å‰å…ˆåˆ†ææ–‡ä»¶åˆ¤æ–­ä»»åŠ¡ç±»å‹ |
| P1 | `agent/prompts/system.py` | æ·»åŠ è¿½é—®è§„åˆ™ï¼Œè¦æ±‚å…ˆåˆ†ææ–‡ä»¶å†è¿½é—® |
| P1 | `skills/micro_emission/handlers.py` | æ·»åŠ  `generate_result_excel()` å‡½æ•°ï¼Œè¿”å›ä¸‹è½½æ–‡ä»¶ä¿¡æ¯ |
| P1 | `skills/macro_emission/handlers.py` | åŒä¸Š |
| P2 | `api/routes.py` | æ·»åŠ  `/api/download/{filename}` ç«¯ç‚¹ï¼Œå¤„ç†ä¸‹è½½æ–‡ä»¶å“åº” |
| P2 | `web/app.js` | æ·»åŠ ä¸‹è½½æŒ‰é’®æ¸²æŸ“é€»è¾‘ |
| P3 | `web/styles.css` | æ·»åŠ ä¸‹è½½æŒ‰é’®æ ·å¼ï¼ˆå¯é€‰ï¼‰ |

---

## è¾“å‡ºç›®å½•é…ç½®

ç¡®ä¿æœ‰ä¸€ä¸ª `outputs` ç›®å½•ç”¨äºå­˜æ”¾ç”Ÿæˆçš„ç»“æœæ–‡ä»¶ï¼š

```python
# config.py æˆ–ç›¸å…³é…ç½®æ–‡ä»¶

import os

# ç»“æœæ–‡ä»¶è¾“å‡ºç›®å½•
OUTPUTS_DIR = os.path.join(os.path.dirname(__file__), "outputs")
os.makedirs(OUTPUTS_DIR, exist_ok=True)

# æ–‡ä»¶ä¿ç•™æ—¶é—´ï¼ˆå¯é€‰ï¼Œç”¨äºå®šæœŸæ¸…ç†ï¼‰
OUTPUT_FILE_RETENTION_HOURS = 24
```

---

## æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•1ï¼šè¿½é—®è´¨é‡
1. ä¸Šä¼  `macro_05_highway_network.csv`
2. å‘é€"å¸®æˆ‘è®¡ç®—æ’æ”¾"
3. **æœŸæœ›**ï¼šç³»ç»Ÿåˆ†ææ–‡ä»¶åï¼Œå‘ŠçŸ¥å·²æœ‰å­—æ®µï¼Œè¯¢é—®è¦è®¡ç®—å“ªäº›æ±¡æŸ“ç‰©

### æµ‹è¯•2ï¼šä¸‹è½½åŠŸèƒ½ï¼ˆå¾®è§‚ï¼‰
1. ä¸Šä¼ å¾®è§‚è½¨è¿¹æ•°æ®
2. å®Œæˆæ’æ”¾è®¡ç®—
3. **æœŸæœ›**ï¼šæ˜¾ç¤ºä¸‹è½½æŒ‰é’®ï¼Œç‚¹å‡»å¯ä¸‹è½½åŒ…å«æ’æ”¾åˆ—çš„Excel

### æµ‹è¯•3ï¼šä¸‹è½½åŠŸèƒ½ï¼ˆå®è§‚ï¼‰
1. ä¸Šä¼ å®è§‚è·¯ç½‘æ•°æ®
2. å®Œæˆæ’æ”¾è®¡ç®—
3. **æœŸæœ›**ï¼šæ˜¾ç¤ºä¸‹è½½æŒ‰é’®ï¼Œä¸‹è½½æ–‡ä»¶åŒ…å«æ¯æ¡è·¯æ®µçš„æ’æ”¾é‡

---

## æ³¨æ„äº‹é¡¹

1. **æ–‡ä»¶æ¸…ç†**ï¼šå®šæœŸæ¸…ç† `outputs` ç›®å½•ï¼Œé¿å…ç£ç›˜ç©ºé—´å ç”¨è¿‡å¤š
2. **å¹¶å‘å®‰å…¨**ï¼šæ–‡ä»¶åä½¿ç”¨æ—¶é—´æˆ³+éšæœºæ•°ï¼Œé¿å…å†²çª
3. **å®‰å…¨æ£€æŸ¥**ï¼šä¸‹è½½ç«¯ç‚¹è¦é˜²æ­¢è·¯å¾„éå†æ”»å‡»
4. **å¤§æ–‡ä»¶å¤„ç†**ï¼šå¦‚æœæ•°æ®é‡å¾ˆå¤§ï¼Œè€ƒè™‘åˆ†æ‰¹å†™å…¥æˆ–ä½¿ç”¨æµå¼ä¸‹è½½

---

## æ‰§è¡Œé¡ºåºå»ºè®®

1. **é¦–å…ˆå®Œæˆä»»åŠ¡0ï¼ˆä»»åŠ¡ç±»å‹åˆ¤æ–­ï¼‰** - è¿™æ˜¯æœ€ä¸¥é‡çš„bugï¼Œå®è§‚æ–‡ä»¶è¢«å½“ä½œå¾®è§‚å¤„ç†
2. ç„¶åå®Œæˆ**ä»»åŠ¡1ï¼ˆè¿½é—®ä¼˜åŒ–ï¼‰** - åœ¨ä»»åŠ¡0åŸºç¡€ä¸Šè¿›ä¸€æ­¥æå‡è¿½é—®è´¨é‡
3. æœ€åå®Œæˆ**ä»»åŠ¡2ï¼ˆä¸‹è½½åŠŸèƒ½ï¼‰** - æ–°åŠŸèƒ½ï¼Œæ”¹åŠ¨ç›¸å¯¹ç‹¬ç«‹

å®Œæˆåè¿›è¡Œç«¯åˆ°ç«¯æµ‹è¯•ï¼š
- æµ‹è¯•å¾®è§‚æ–‡ä»¶ï¼šåº”è¯¥è¿½é—®è½¦å‹
- æµ‹è¯•å®è§‚æ–‡ä»¶ï¼ˆæœ‰è½¦å‹æ¯”ä¾‹ï¼‰ï¼šåº”è¯¥ç›´æ¥è¯†åˆ«ï¼Œä¸è¿½é—®è½¦å‹
- æµ‹è¯•å®è§‚æ–‡ä»¶ï¼ˆæ— è½¦å‹æ¯”ä¾‹ï¼‰ï¼šåº”è¯¥è¿½é—®æ˜¯å¦ä½¿ç”¨é»˜è®¤æ¯”ä¾‹
- æµ‹è¯•ä¸‹è½½åŠŸèƒ½ï¼šè®¡ç®—å®Œæˆåèƒ½ä¸‹è½½ç»“æœExcel
