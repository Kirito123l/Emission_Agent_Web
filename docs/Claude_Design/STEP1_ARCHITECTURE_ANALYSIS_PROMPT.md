# Emission Agent 架构分析任务

## 目的

在进行重构之前，需要先了解当前系统的架构和数据流。请详细分析并汇报以下内容。

## 项目位置
`D:\Agent_MCP\emission_agent`

---

## 请分析并汇报以下内容

### 1. 核心处理流程

请画出当前用户消息的处理流程（从用户发送消息到返回结果）：

```
用户消息 → ? → ? → ? → 返回结果
```

具体说明：
- 入口在哪个文件的哪个函数？
- Planning 在哪里发生？
- Skill 执行在哪里发生？
- 文件是在哪个环节被读取的？

### 2. 文件处理流程

当用户上传文件时：
- 文件路径是怎么传递给 Agent 的？
- Agent 是在哪个环节知道有文件的？
- 文件内容（列名、行数等）是在哪个环节被读取的？
- 当前是谁负责判断文件是微观还是宏观？

### 3. Planning 阶段

关于 `agent/planner.py`（或类似文件）：
- Planning 的输入是什么？（用户消息、上下文、文件信息？）
- Planning 的输出是什么？（计划结构是怎样的？）
- Planning 时能否访问文件内容？还是只有文件路径？
- 追问（needs_clarification）是在 Planning 阶段生成的吗？

### 4. Skill 执行阶段

关于 `skills/micro_emission/` 和 `skills/macro_emission/`：
- Skill 的入口函数是什么？
- Skill 是怎么接收参数的？
- 文件分析（读取列名、判断类型）是在 Skill 内部做的吗？
- 如果 Skill 发现缺少参数（如 vehicle_type），它怎么处理？

### 5. 智能列名映射

关于列名映射功能：
- 在哪个文件实现的？
- 是在什么时机触发的？（Planning？Skill执行？）
- 映射结果怎么返回给用户或 Agent？

### 6. System Prompt 结构

关于 `agent/prompts/system.py`：
- 当前 prompt 的主要部分有哪些？
- 文件处理规则在哪个部分？
- 追问规则在哪个部分？
- 大概有多少行？结构是否清晰？

---

## 输出格式

请按以下格式输出分析报告：

```markdown
# Emission Agent 架构分析报告

## 1. 核心处理流程

[流程图]

入口: `文件名:函数名`
Planning: `文件名:函数名`
执行: `文件名:函数名`

## 2. 文件处理流程

[说明文件从上传到处理的完整路径]

## 3. Planning 阶段详情

输入: ...
输出: ...
能否访问文件内容: 是/否
追问生成位置: ...

## 4. Skill 执行详情

[每个 Skill 的结构说明]

## 5. 智能列名映射

位置: ...
触发时机: ...

## 6. System Prompt 结构

[当前 prompt 的目录结构]

## 7. 发现的问题

[当前架构中可能导致问题的地方]

## 8. 建议的改进点

[基于分析，哪些地方需要改进]
```

---

## 重点关注

我特别想了解：

1. **为什么 Agent 会用 query_knowledge 而不是直接调用 Skill？**
   - 是因为 Planning 阶段看不到文件内容？
   - 还是 prompt 没有说清楚？

2. **文件分析能力在哪里？**
   - 如果已经有文件分析能力，为什么 Planning 时没用上？
   - 如果没有，应该加在哪里？

3. **追问逻辑在哪里？**
   - 是 LLM 生成的？还是代码逻辑判断的？
   - 能否让代码自动生成高质量追问？

---

请仔细阅读代码后输出分析报告，这将帮助我们设计更好的重构方案。
